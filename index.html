<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Blackburn Kia Nissan GWM ‚Äì Advisor Performance Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PapaParse for CSV loading -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg: #050510;
      --bg-alt: #0b0b1a;
      --card: #141527;
      --accent: #00bcd4;
      --accent-soft: #00bcd466;
      --text: #f5f5f5;
      --muted: #9ea4c6;
      --border: #262a40;
      --danger: #ff5252;
      --success: #4caf50;
      --warning: #ffc107;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.9);
      --bg-body: radial-gradient(circle at top left, #111827 0, #020617 55%);
      --card-soft: radial-gradient(circle at top left, #1f2933 0, #141527 45%);
    }

    body.light {
      --bg: #f3f4f6;
      --bg-alt: #e5e7eb;
      --card: #ffffff;
      --accent: #0284c7;
      --accent-soft: #0284c766;
      --text: #0f172a;
      --muted: #6b7280;
      --border: #d1d5db;
      --danger: #b91c1c;
      --success: #16a34a;
      --warning: #d97706;
      --shadow: 0 8px 20px rgba(148, 163, 184, 0.45);
      --bg-body: radial-gradient(circle at top left, #e5e7eb 0, #f9fafb 55%);
      --card-soft: radial-gradient(circle at top left, #e5e7eb 0, #ffffff 45%);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg-body);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: background 0.25s ease, color 0.25s ease;
    }

    .shell {
      width: min(1120px, 96%);
      margin: 24px auto 40px;
    }

    header {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
    }

    .pulse-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 12px var(--accent-soft);
    }

    h1 {
      margin: 0;
      font-size: clamp(20px, 2.4vw, 26px);
      font-weight: 600;
    }

    .subtitle {
      font-size: 12px;
      color: var(--muted);
    }

    .header-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
    }

    select, input[type="date"], input[type="text"], input[type="number"], textarea {
      background: #020617;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 10px;
      font-size: 12px;
      color: var(--text);
      outline: none;
      min-width: 130px;
    }

    body.light select,
    body.light input[type="date"],
    body.light input[type="text"],
    body.light input[type="number"],
    body.light textarea {
      background: #ffffff;
      border-color: var(--border);
      color: var(--text);
    }

    textarea {
      border-radius: 12px;
      min-height: 60px;
      resize: vertical;
    }

    button {
      border: none;
      border-radius: 999px;
      font-size: 12px;
      padding: 8px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #020617;
      color: var(--text);
      border: 1px solid var(--border);
      transition: background 0.18s ease, transform 0.12s ease, box-shadow 0.18s ease, color 0.18s ease;
    }

    body.light button {
      background: #ffffff;
      color: var(--text);
    }

    button.primary {
      background: linear-gradient(135deg, var(--accent), #38bdf8);
      border-color: transparent;
      color: #020617;
      font-weight: 600;
      box-shadow: 0 8px 18px rgba(0, 188, 212, 0.35);
    }

    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 24px rgba(0, 188, 212, 0.5);
    }

    button:hover {
      background: #020617;
    }

    body.light button:hover {
      background: #e5e7eb;
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      box-shadow: none;
    }

    .icon-btn {
      width: 34px;
      height: 34px;
      justify-content: center;
      padding: 0;
      font-size: 16px;
    }

    .upload-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      margin-top: 18px;
      border-radius: 14px;
      background: radial-gradient(circle at top left, #1f2937 0, #020617 70%);
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow: var(--shadow);
      font-size: 11px;
      color: var(--muted);
    }

    body.light .upload-bar {
      background: radial-gradient(circle at top left, #e5e7eb 0, #f9fafb 70%);
      border-color: #e5e7eb;
    }

    .upload-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .upload-title {
      font-size: 12px;
      color: #e5e7eb;
      font-weight: 500;
    }

    body.light .upload-title {
      color: #111827;
    }

    .upload-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .status-pill {
      font-size: 10px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #64748b;
    }

    .status-pill.good .status-dot { background: #22c55e; }
    .status-pill.bad .status-dot { background: #ef4444; }

    .status-pill.good {
      border-color: rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
    }

    .status-pill.bad {
      border-color: rgba(248, 113, 113, 0.8);
      color: #fecaca;
    }

    body.light .status-pill {
      background: #ffffff;
      border-color: var(--border);
      color: var(--muted);
    }

    .main-tabs {
      display: inline-flex;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      padding: 4px;
      border: 1px solid var(--border);
      margin-bottom: 12px;
    }

    body.light .main-tabs {
      background: #e5e7eb;
      border-color: #d1d5db;
    }

    .main-tab {
      border-radius: 999px;
      padding: 6px 16px;
      font-size: 12px;
      cursor: pointer;
      color: var(--muted);
      border: none;
      background: transparent;
      transition: background 0.18s ease, color 0.18s ease;
    }

    .main-tab.active {
      background: linear-gradient(135deg, #1e293b, #020617);
      color: #e5e7eb;
    }

    body.light .main-tab.active {
      background: #ffffff;
      color: #111827;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 900px) {
      .grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-controls {
        width: 100%;
        justify-content: flex-start;
      }
      .grid { grid-template-columns: minmax(0, 1fr); }
      .upload-bar { align-items: flex-start; }
    }

    .card {
      background: var(--card-soft);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 12px 12px 14px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .card h3 {
      margin: 0 0 2px;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-sub {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .metric-main {
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .metric-target {
      font-size: 11px;
      color: var(--muted);
    }

    .pill {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--muted);
    }

    .pill.good {
      border-color: rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
      background: rgba(22, 163, 74, 0.18);
    }

    .pill.bad {
      border-color: rgba(248, 113, 113, 0.8);
      color: #fecaca;
      background: rgba(239, 68, 68, 0.16);
    }

    .gauge {
      width: 100%;
      height: 9px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.95);
      overflow: hidden;
      margin: 6px 0 2px;
      border: 1px solid rgba(30, 64, 175, 0.7);
    }

    body.light .gauge {
      background: #e5e7eb;
      border-color: #cbd5f5;
    }

    .gauge-fill {
      height: 100%;
      width: var(--value, 40%);
      border-radius: inherit;
      background: linear-gradient(90deg, var(--accent), #22c55e);
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.6);
    }

    .gauge-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }

    /* Mix bar for Customer/Warranty/Internal */
    .mix-bar {
      display: flex;
      width: 100%;
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      margin-top: 4px;
      margin-bottom: 2px;
    }

    body.light .mix-bar {
      background: #e5e7eb;
    }

    .mix-segment {
      height: 100%;
    }

    .mix-customer {
      background: linear-gradient(90deg, #22c55e, #86efac);
    }

    .mix-warranty {
      background: linear-gradient(90deg, #f97316, #fed7aa);
    }

    .mix-internal {
      background: linear-gradient(90deg, #6366f1, #a5b4fc);
    }

    .section-title {
      margin: 18px 0 8px;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
    }

    .summary-row {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .summary-row strong {
      color: var(--text);
    }

    .advisor-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }

    .advisor-card {
      background: #020617;
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 10px 11px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    body.light .advisor-card {
      background: #ffffff;
      border-color: #e5e7eb;
    }

    .advisor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .advisor-name {
      font-size: 12px;
      font-weight: 500;
    }

    .advisor-rank {
      font-size: 10px;
      color: var(--muted);
    }

    .advisor-metrics {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 10px;
      color: var(--muted);
    }

    .chip {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(51, 65, 85, 0.9);
    }

    body.light .chip {
      background: #f3f4f6;
      border-color: #d1d5db;
    }

    .leaderboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }

    .lb-card {
      background: #020617;
      border-radius: 16px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      padding: 10px 11px;
      font-size: 11px;
    }

    body.light .lb-card {
      background: #ffffff;
      border-color: #d1d5db;
    }

    .lb-title {
      font-size: 11px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .lb-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .lb-row span:first-child { color: var(--muted); }

    .hidden { display: none !important; }

    .loading {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .error {
      font-size: 11px;
      color: #fecaca;
      margin-top: 4px;
    }

    /* Modal */
    #insightsModal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.82);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal {
      width: min(520px, 92%);
      background: radial-gradient(circle at top left, #1f2933 0, #020617 55%);
      border-radius: 20px;
      border: 1px solid var(--border);
      padding: 14px 16px 14px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.95);
    }

    body.light .modal {
      background: radial-gradient(circle at top left, #e5e7eb 0, #ffffff 55%);
      border-color: #e5e7eb;
      box-shadow: 0 18px 45px rgba(148, 163, 184, 0.9);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 14px;
    }

    .pill-soft {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.6);
      color: var(--muted);
    }

    body.light .pill-soft {
      background: #ffffff;
      border-color: #d1d5db;
    }

    .modal-body {
      font-size: 11px;
      color: var(--muted);
      max-height: 380px;
      overflow-y: auto;
    }

    .insight-item {
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px dashed rgba(51, 65, 85, 0.7);
    }

    .insight-item:last-child { border-bottom: none; }

    .insight-tag {
      font-size: 10px;
      color: #bfdbfe;
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .insight-text { margin-top: 3px; }

    /* Settings page */
    #page-settings { margin-top: 10px; }

    .settings-grid {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 12px;
    }

    @media (max-width: 900px) {
      .settings-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .settings-card {
      background: #020617;
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      font-size: 11px;
    }

    body.light .settings-card {
      background: #ffffff;
      border-color: #e5e7eb;
    }

    .settings-card h3 {
      margin: 0 0 6px;
      font-size: 13px;
    }

    .field-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-bottom: 6px;
    }

    .field-group label {
      font-size: 11px;
      color: var(--muted);
      min-width: 120px;
    }

    .field-group small {
      font-size: 10px;
      color: var(--muted);
    }

    .inline-note {
      font-size: 10px;
      color: var(--muted);
      margin-top: 4px;
    }

    .policy-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      margin-top: 4px;
    }

    .policy-table th,
    .policy-table td {
      border-bottom: 1px solid rgba(51, 65, 85, 0.7);
      padding: 4px 4px;
      text-align: left;
    }

    body.light .policy-table th,
    body.light .policy-table td {
      border-color: #e5e7eb;
    }

    .policy-table th {
      color: var(--muted);
      font-weight: 500;
    }

    .policy-table input[type="text"],
    .policy-table input[type="number"] {
      width: 100%;
      min-width: 0;
      border-radius: 8px;
      font-size: 11px;
      padding: 4px 8px;
    }

    .pill-outline {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    body.light .pill-outline {
      border-color: #d1d5db;
    }

    /* Leaderboard side panel */
    #leaderboardPanel {
      position: fixed;
      inset: 0;
      display: flex;
      justify-content: flex-end;
      align-items: stretch;
      background: rgba(15, 23, 42, 0.65);
      z-index: 45;
    }

    .lb-panel-inner {
      width: min(360px, 90%);
      background: #020617;
      border-left: 1px solid var(--border);
      box-shadow: -12px 0 30px rgba(15, 23, 42, 0.9);
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    body.light .lb-panel-inner {
      background: #ffffff;
      box-shadow: -12px 0 30px rgba(148, 163, 184, 0.8);
    }

    .lb-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .lb-panel-header h2 {
      margin: 0;
      font-size: 14px;
    }

    .lb-panel-body {
      font-size: 11px;
      color: var(--muted);
      overflow-y: auto;
      max-height: calc(100vh - 80px);
    }

    .lb-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      margin-top: 8px;
      margin-bottom: 4px;
      color: var(--muted);
    }

    .lb-list-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .lb-list-row span:first-child {
      color: var(--muted);
    }

    .lb-summary {
      font-size: 11px;
      margin-bottom: 6px;
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="title-block">
        <div class="badge">
          <span class="pulse-dot"></span>
          BLACKBURN KIA NISSAN GWM
        </div>
        <h1>Advisor Performance ‚Äì Service Dashboard</h1>
        <div class="subtitle">
          Single export only: consolidated advisor performance by unique RO. CustomerClosedDate drives
          advisor metrics; internal / warranty open ROs are flagged separately.
        </div>
      </div>

      <div class="header-controls">
        <input type="date" id="datePicker" />
        <select id="advisorFilter">
          <option value="all">All Advisors</option>
        </select>
        <button id="leaderboardToggle">üèÜ Leaderboard</button>
        <button id="insightsBtn">‚ú® Insights</button>
        <button id="themeToggleBtn" class="icon-btn" title="Toggle theme">üåì</button>
        <button id="reloadOnlineBtn">üîÑ Reload Online Data</button>
      </div>
    </header>

    <!-- MAIN TABS -->
    <div class="main-tabs">
      <button class="main-tab active" data-page="dashboard">Dashboard</button>
      <button class="main-tab" data-page="settings">Settings</button>
    </div>
<!-- ========================= -->
<!-- ===== DASHBOARD PAGE ==== -->
<!-- ========================= -->

<div id="page-dashboard">

  <!-- DAILY SECTION -->
  <div class="section-title">Daily Performance</div>

  <!-- DAILY GAUGES -->
  <div class="grid" id="dailyGaugeGrid">
    <!-- JS will inject gauge cards here -->
  </div>

  <!-- DAILY WORK MIX -->
  <div class="section-title">Daily Work Mix</div>
  <div id="dailyMixContainer">
    <!-- JS will inject stacked bar + counts -->
  </div>

  <!-- DAILY ADVISOR CARDS -->
  <div class="section-title">Daily ‚Äì Advisors</div>
  <div class="advisor-list" id="dailyAdvisorList">
    <!-- JS will inject advisor cards -->
  </div>



  <!-- MTD SECTION -->
  <div class="section-title" style="margin-top:38px;">Month-To-Date Performance</div>

  <!-- MTD GAUGES -->
  <div class="grid" id="mtdGaugeGrid">
    <!-- JS will inject gauge cards here -->
  </div>

  <!-- MTD WORK MIX -->
  <div class="section-title">MTD Work Mix</div>
  <div id="mtdMixContainer">
    <!-- JS will inject stacked bar + counts -->
  </div>

  <!-- MTD ADVISOR CARDS -->
  <div class="section-title">MTD ‚Äì Advisors</div>
  <div class="advisor-list" id="mtdAdvisorList">
    <!-- JS will inject advisor cards -->
  </div>

</div>





<!-- ========================= -->
<!-- ===== SETTINGS PAGE ===== -->
<!-- ========================= -->

<div id="page-settings" class="hidden">

  <div class="settings-grid">

    <!-- LEFT COLUMN -->
    <div class="settings-card">
      <h3>Data Source</h3>

      <div class="field-group">
        <label>Online CSV URL</label>
        <input type="text" id="onlineCsvUrl" placeholder="https://docs.google.com/...export?format=csv">
      </div>

      <div class="field-group">
        <label>Try Online First?</label>
        <select id="dataMode">
          <option value="online">Try online first</option>
          <option value="upload">Upload only</option>
        </select>
      </div>

      <div class="field-group">
        <label>Daily Labour Target ($)</label>
        <input type="number" id="dailyLabourTarget" value="16000">
      </div>

      <div class="field-group">
        <label>MTD Labour Target ($)</label>
        <input type="number" id="mtdLabourTarget" value="280000">
      </div>

      <button id="saveSettingsBtn" class="primary" style="margin-top:10px;">Save Settings</button>
    </div>



    <!-- RIGHT COLUMN -->
    <div class="settings-card">
      <h3>Brand Policy Mix</h3>

      <table class="policy-table">
        <tr>
          <th>Brand</th>
          <th>Policy %</th>
        </tr>
        <tr>
          <td>Kia</td>
          <td><input type="number" class="policy-input" data-brand="Kia" value="0"></td>
        </tr>
        <tr>
          <td>Nissan</td>
          <td><input type="number" class="policy-input" data-brand="Nissan" value="0"></td>
        </tr>
        <tr>
          <td>GWM</td>
          <td><input type="number" class="policy-input" data-brand="GWM" value="0"></td>
        </tr>
      </table>

      <div class="inline-note">
        These values adjust the ‚Äúpolicy‚Äù portion of GP calculations.
      </div>
    </div>

  </div>

</div>





<!-- ========================= -->
<!-- ===== FOOTER UPLOAD ===== -->
<!-- ========================= -->

<div class="upload-bar" id="uploadBar">

  <div class="upload-left">
    <div class="upload-title">CSV Import & Online Sync</div>
    <span id="uploadStatus" class="loading">Awaiting upload or online pull‚Ä¶</span>
  </div>

  <div class="upload-controls">
    <input type="file" id="csvInput" accept=".csv" />
    <button id="uploadBtn">üìÇ Upload CSV</button>
    <button id="loadOnlineBtn">üåê Load Online CSV</button>
  </div>

</div>





<!-- ========================= -->
<!-- ===== INSIGHTS MODAL ==== -->
<!-- ========================= -->

<div id="insightsModal" class="hidden">
  <div class="modal">
    <div class="modal-header">
      <h2>Advisor Insights</h2>
      <button id="closeInsights" class="icon-btn">‚úñ</button>
    </div>

    <div class="modal-body" id="insightsBody">
      <!-- JS will inject insights here -->
    </div>
  </div>
</div>





<!-- ============================== -->
<!-- ===== LEADERBOARD PANEL ====== -->
<!-- ============================== -->

<div id="leaderboardPanel" class="hidden">
  <div class="lb-panel-inner">
    <div class="lb-panel-header">
      <h2>Advisor Leaderboard</h2>
      <button id="closeLeaderboard" class="icon-btn">‚úñ</button>
    </div>

    <div class="lb-panel-body" id="leaderboardBody">
      <!-- JS will inject results -->
    </div>
  </div>
</div>
<script>
// ======================================================
// =============== GLOBAL STATE ==========================
// ======================================================

let RAW_ROWS = [];            // Raw CSV rows
let CONSOLIDATED = [];        // Unique RO-level rows
let SETTINGS = {};            // Loaded from localStorage
let ADVISORS = [];            // Unique advisor names after consolidation
let LOAD_MODE = "online";     // online / upload
let ONLINE_URL = "";          // Google Sheets CSV URL


// ======================================================
// =============== SETTINGS ENGINE =======================
// ======================================================

function loadSettings() {
  try {
    const s = JSON.parse(localStorage.getItem("advisor-settings"));
    SETTINGS = s || {
      dailyLabourTarget: 16000,
      mtdLabourTarget: 280000,
      policy: { Kia: 0, Nissan: 0, GWM: 0 },
      mode: "online",
      onlineUrl: "https://docs.google.com/spreadsheets/d/1fiwosf8gXN6faN-LHQtvAIfMbAagEptqWkwiPE23Vbg/export?format=csv"
    };
  } catch {
    SETTINGS = {
      dailyLabourTarget: 16000,
      mtdLabourTarget: 280000,
      policy: { Kia: 0, Nissan: 0, GWM: 0 },
      mode: "online",
      onlineUrl: "https://docs.google.com/spreadsheets/d/1fiwosf8gXN6faN-LHQtvAIfMbAagEptqWkwiPE23Vbg/export?format=csv"
    };
  }

  LOAD_MODE = SETTINGS.mode;
  ONLINE_URL = SETTINGS.onlineUrl;
}

function saveSettings() {
  localStorage.setItem("advisor-settings", JSON.stringify(SETTINGS));
}



// ======================================================
// =============== CSV LOADING ===========================
// ======================================================

async function loadOnlineCsv() {
  setUploadStatus("Loading online‚Ä¶");

  try {
    const res = await fetch(ONLINE_URL);
    if (!res.ok) throw new Error("HTTP " + res.status);

    const text = await res.text();
    parseCsv(text);
    setUploadStatus("Online CSV loaded ‚úî");
  } catch (err) {
    console.error(err);
    setUploadStatus("Failed to load online CSV");
  }
}

function handleCsvUpload(file) {
  setUploadStatus("Reading file‚Ä¶");

  const reader = new FileReader();
  reader.onload = e => {
    parseCsv(e.target.result);
    setUploadStatus("CSV loaded ‚úî");
  };
  reader.readAsText(file);
}

function parseCsv(text) {
  Papa.parse(text, {
    header: true,
    skipEmptyLines: true,
    complete: results => {
      RAW_ROWS = results.data || [];
      consolidateROs();
    }
  });
}



// ======================================================
// =============== NORMALISATION HELPERS =================
// ======================================================

function toNum(x) {
  if (x === null || x === undefined) return 0;
  if (typeof x === "number") return x;
  const n = parseFloat(String(x).replace(/[^0-9.\-]/g, ""));
  return isNaN(n) ? 0 : n;
}

function parseAuDate(str) {
  if (!str) return null;
  const p = str.split(/[\/\-]/).map(n => parseInt(n));
  if (p.length < 3) return null;
  return new Date(p[2], p[1] - 1, p[0]);
}

function classifyType(row) {
  const t = (row["Type"] || row["RO Type"] || "").toLowerCase();

  if (t.startsWith("w")) return "warranty";
  if (t.startsWith("i")) return "internal";
  return "retail"; // customer
}



// ======================================================
// =============== RO CONSOLIDATION ENGINE ===============
// ======================================================
// Your rule: ‚ÄúOption B ‚Äì advisor with MOST FREQUENT appearances per RO‚Äù

function consolidateROs() {
  const map = {}; // roNumber ‚Üí array of rows

  RAW_ROWS.forEach(r => {
    const ro = String(r["RO#"] || r["RO Number"] || r["RO"] || "").trim();
    if (!ro) return;

    if (!map[ro]) map[ro] = [];
    map[ro].push(r);
  });

  const finalList = [];

  Object.keys(map).forEach(ro => {
    const lines = map[ro];

    // Pick MOST FREQUENT advisor
    const advisorCounts = {};
    lines.forEach(l => {
      const a = String(l["Advisor Name"] || "").trim();
      if (!a) return;
      advisorCounts[a] = (advisorCounts[a] || 0) + 1;
    });

    let finalAdvisor = "Unknown";
    let maxCount = 0;
    Object.keys(advisorCounts).forEach(a => {
      if (advisorCounts[a] > maxCount) {
        maxCount = advisorCounts[a];
        finalAdvisor = a;
      }
    });

    // Aggregate all financial/time fields
    let gross = 0;
    let cost = 0;
    let billed = 0;
    let tech = 0;

    let roType = "retail";

    lines.forEach(l => {
      gross += toNum(l["Gross Amt"]) || toNum(l["Labour Gross"]);
      cost += toNum(l["Cost"]) || toNum(l["Labour Cost"]);
      billed += toNum(l["Charged Hrs"]);
      tech += toNum(l["TotalTimeHours"]);

      const type = classifyType(l);
      if (type !== "retail") roType = type; // warranty/internal override
    });

    finalList.push({
      roNumber: ro,
      advisor: finalAdvisor,
      gross,
      cost,
      billed,
      tech,
      type: roType,
      closeDate: parseAuDate(
        lines[0]["CustomerClosedDate"] ||
        lines[0]["Closed Date"] ||
        lines[0]["Date"]
      )
    });
  });

  // Filter out ghost advisors: < $1000 labour
  CONSOLIDATED = finalList.filter(x => x.gross >= 1000);

  // Update advisor list
  ADVISORS = [...new Set(CONSOLIDATED.map(x => x.advisor))];

  console.log("Consolidated ROs:", CONSOLIDATED);

  // Trigger next step: render
  if (typeof renderAll === "function") {
    renderAll();
  }
}



// ======================================================
// =============== STATUS HELPER ==========================
// ======================================================

function setUploadStatus(msg) {
  const el = document.getElementById("uploadStatus");
  if (el) el.textContent = msg;
}

</script>
<script>
// ======================================================
// =============== FILTERS + DATE HELPERS ===============
// ======================================================

let FILTERS = {
  date: null,       // JS Date for focus day
  advisor: "all"    // "all" or advisor name
};

function setFilterDate(dateObj) {
  FILTERS.date = dateObj instanceof Date && !isNaN(dateObj) ? dateObj : null;
}

function setFilterAdvisor(name) {
  FILTERS.advisor = name && name !== "all" ? String(name).trim() : "all";
}

function getLatestCloseDate() {
  if (!CONSOLIDATED.length) return null;
  let latest = null;

  CONSOLIDATED.forEach(r => {
    if (!r.closeDate) return;
    if (!latest || r.closeDate > latest) latest = r.closeDate;
  });

  return latest;
}

function ensureFilterDate() {
  if (!FILTERS.date) {
    const latest = getLatestCloseDate();
    if (latest) FILTERS.date = latest;
  }
  return FILTERS.date;
}

function sameDay(d1, d2) {
  return (
    d1.getFullYear() === d2.getFullYear() &&
    d1.getMonth() === d2.getMonth() &&
    d1.getDate() === d2.getDate()
  );
}

function sameMonth(d1, d2) {
  return (
    d1.getFullYear() === d2.getFullYear() &&
    d1.getMonth() === d2.getMonth()
  );
}



// ======================================================
// =============== ROW FILTERS (DAILY / MTD) ============
// ======================================================

function getDailyRows() {
  if (!CONSOLIDATED.length) return [];
  const baseDate = ensureFilterDate();
  if (!baseDate) return [];

  return CONSOLIDATED.filter(r => {
    if (!r.closeDate) return false;
    if (!sameDay(r.closeDate, baseDate)) return false;
    if (FILTERS.advisor !== "all" && r.advisor !== FILTERS.advisor) return false;
    return true;
  });
}

function getMtdRowsFiltered() {
  if (!CONSOLIDATED.length) return [];
  const baseDate = ensureFilterDate();
  if (!baseDate) return [];

  return CONSOLIDATED.filter(r => {
    if (!r.closeDate) return false;
    if (!sameMonth(r.closeDate, baseDate)) return false;
    if (FILTERS.advisor !== "all" && r.advisor !== FILTERS.advisor) return false;
    return true;
  });
}

function getMtdRowsAllAdvisors() {
  if (!CONSOLIDATED.length) return [];
  const baseDate = ensureFilterDate();
  if (!baseDate) return [];

  return CONSOLIDATED.filter(r => {
    if (!r.closeDate) return false;
    return sameMonth(r.closeDate, baseDate);
  });
}



// ======================================================
// =============== ADVISOR STAT BUILDERS ================
// ======================================================

function buildAdvisorStats(rows) {
  const map = {};

  rows.forEach(r => {
    const name = r.advisor || "Unknown";
    if (!map[name]) {
      map[name] = {
        advisor: name,
        labourGross: 0,
        cost: 0,
        roCount: 0,
        billedHrs: 0,
        techHrs: 0
      };
    }

    map[name].labourGross += toNum(r.gross);
    map[name].cost       += toNum(r.cost);
    map[name].roCount    += 1;
    map[name].billedHrs  += toNum(r.billed);
    map[name].techHrs    += toNum(r.tech);
  });

  const list = Object.values(map);

  list.forEach(a => {
    a.avgRO = a.roCount ? a.labourGross / a.roCount : 0;
    const billed = a.billedHrs || 0;
    const tech   = a.techHrs   || 0;

    a.leakagePct = tech > 0 ? (1 - billed / tech) * 100 : 0;

    if (a.labourGross > 0) {
      a.gpPct = ((a.labourGross - a.cost) / a.labourGross) * 100;
    } else {
      a.gpPct = 0;
    }
  });

  // Sort by labour gross (desc)
  list.sort((a, b) => b.labourGross - a.labourGross);
  return list;
}



// ======================================================
// =============== DAILY METRICS ========================
// ======================================================

function buildDailyMetrics() {
  const rows = getDailyRows();

  let roCount = 0;
  let retail = 0;
  let warranty = 0;
  let internal = 0;

  let totalGross = 0;
  let totalCost  = 0;
  let totalTech  = 0;
  let totalBilled = 0;

  rows.forEach(r => {
    roCount++;
    totalGross  += toNum(r.gross);
    totalCost   += toNum(r.cost);
    totalTech   += toNum(r.tech);
    totalBilled += toNum(r.billed);

    if (r.type === "warranty") warranty++;
    else if (r.type === "internal") internal++;
    else retail++;
  });

  const advisorStats = buildAdvisorStats(rows);
  const avgGrossPerRO = roCount ? totalGross / roCount : 0;
  const billedRatio   = totalTech > 0 ? totalBilled / totalTech : 1;

  let gpPct = 0;
  if (totalGross > 0) {
    gpPct = ((totalGross - totalCost) / totalGross) * 100;
  }

  return {
    rows,
    roCount,
    retail,
    warranty,
    internal,
    totalGross,
    totalCost,
    totalTech,
    totalBilled,
    avgGrossPerRO,
    billedRatio,
    gpPct,
    advisorStats
  };
}



// ======================================================
// =============== MTD METRICS ==========================
// ======================================================

function buildMtdMetrics() {
  const rows = getMtdRowsFiltered();

  let roCount = 0;
  let retail = 0;
  let warranty = 0;
  let internal = 0;

  let totalGross = 0;
  let totalCost  = 0;
  let totalTech  = 0;
  let totalBilled = 0;

  rows.forEach(r => {
    roCount++;
    totalGross  += toNum(r.gross);
    totalCost   += toNum(r.cost);
    totalTech   += toNum(r.tech);
    totalBilled += toNum(r.billed);

    if (r.type === "warranty") warranty++;
    else if (r.type === "internal") internal++;
    else retail++;
  });

  const advisorStats = buildAdvisorStats(rows);
  const avgGrossPerRO = roCount ? totalGross / roCount : 0;
  const billedRatio   = totalTech > 0 ? totalBilled / totalTech : 1;

  let gpPct = 0;
  if (totalGross > 0) {
    gpPct = ((totalGross - totalCost) / totalGross) * 100;
  }

  const nonRetail = warranty + internal;
  const totalROs  = retail + nonRetail;
  const nonRetailPct = totalROs > 0 ? (nonRetail / totalROs) * 100 : 0;

  return {
    rows,
    roCount,
    retail,
    warranty,
    internal,
    nonRetail,
    nonRetailPct,
    totalGross,
    totalCost,
    totalTech,
    totalBilled,
    avgGrossPerRO,
    billedRatio,
    gpPct,
    advisorStats
  };
}



// ======================================================
// =============== WORK MIX (STACKED BAR) ===============
// ======================================================

function buildMtdWorkMixAll() {
  const rows = getMtdRowsAllAdvisors();

  let retail = 0;
  let warranty = 0;
  let internal = 0;

  rows.forEach(r => {
    if (r.type === "warranty") warranty++;
    else if (r.type === "internal") internal++;
    else retail++;
  });

  const total = retail + warranty + internal;
  const pctRetail   = total > 0 ? (retail   / total) * 100 : 0;
  const pctWarranty = total > 0 ? (warranty / total) * 100 : 0;
  const pctInternal = total > 0 ? (internal / total) * 100 : 0;

  return {
    retail,
    warranty,
    internal,
    total,
    pctRetail,
    pctWarranty,
    pctInternal
  };
}



// ======================================================
// =============== MTD RANKING MAP (GLOBAL) =============
// ======================================================

function buildMtdRankMap() {
  const allRows = getMtdRowsAllAdvisors();
  const allStats = buildAdvisorStats(allRows);  // all advisors regardless of filter

  const rankMap = {};
  allStats.forEach((a, idx) => {
    rankMap[a.advisor] = idx + 1;
  });

  return {
    allStats,
    rankMap
  };
}

</script>
<script>
/* ======================================================
   BLOCK 5 ‚Äî RENDER ENGINE
   ====================================================== */


/* ---------------- GAUGE GENERATOR ---------------- */
function renderGauge(parent, value, max, label) {
  const pct = max > 0 ? Math.min(value / max, 1) : 0;
  const dash = 565.48; // circumference of 180¬∞ arc
  const offset = dash * (1 - pct);

  parent.innerHTML = `
    <div class="gauge">
      <svg viewBox="0 0 200 100">
        <path class="bg-circle"
          d="M10 100 A90 90 0 0 1 190 100" />
        <path class="progress-circle"
          stroke-dasharray="${dash}"
          stroke-dashoffset="${offset}"
          d="M10 100 A90 90 0 0 1 190 100" />
      </svg>

      <div class="value-text">${value.toLocaleString("en-AU")}</div>
      <div class="label-text">${label}</div>
    </div>
  `;
}


/* ---------------- MIX BAR ---------------- */
function renderMixBar(container, mix) {
  container.innerHTML = `
    <div class="mix-bar-container">
      <div class="mix-segment mix-customer" style="width:${mix.pctRetail}%;"></div>
      <div class="mix-segment mix-warranty" style="width:${mix.pctWarranty}%;"></div>
      <div class="mix-segment mix-internal" style="width:${mix.pctInternal}%;"></div>
    </div>

    <div class="mix-legend">
      <div>Retail: ${mix.retail} (${mix.pctRetail.toFixed(1)}%)</div>
      <div>Warranty: ${mix.warranty} (${mix.pctWarranty.toFixed(1)}%)</div>
      <div>Internal: ${mix.internal} (${mix.pctInternal.toFixed(1)}%)</div>
    </div>
  `;
}


/* ---------------- ADVISOR CARDS ---------------- */
function renderAdvisorCards(container, list, rankingMap) {
  container.innerHTML = "";

  list.forEach(a => {
    const card = document.createElement("div");
    card.className = "advisor-card";

    const trueRank = rankingMap[a.advisor] || "-";

    card.innerHTML = `
      <div class="advisor-name">${trueRank}. ${a.advisor}</div>

      <div class="advisor-stat">
        <span>Labour $</span>
        <span>$${a.labourGross.toLocaleString("en-AU")}</span>
      </div>

      <div class="advisor-stat">
        <span>Avg $/RO</span>
        <span>$${a.avgRO.toFixed(0)}</span>
      </div>

      <div class="advisor-stat">
        <span>RO Count</span>
        <span>${a.roCount}</span>
      </div>

      <div class="advisor-stat">
        <span>GP%</span>
        <span>${a.gpPct.toFixed(1)}%</span>
      </div>

      <div class="advisor-stat">
        <span>Leakage</span>
        <span>${a.leakagePct.toFixed(1)}%</span>
      </div>

      <button class="btn" onclick="openInsights('${a.advisor}')">
        View Insights
      </button>
    `;

    container.appendChild(card);
  });
}


/* ---------------- INSIGHTS MODAL ---------------- */
function openInsights(name) {
  const m = document.getElementById("insightsModal");
  const body = document.getElementById("insightsBody");

  const baseDate = ensureFilterDate();

  body.innerHTML = `
    <p><strong>Advisor:</strong> ${name}</p>
    <p><strong>For period:</strong> ${baseDate.toDateString()}</p>
    <hr>
    <p>Nova-generated insights coming dynamically (Block 6).</p>
  `;

  m.classList.remove("hidden");
}

document.getElementById("closeInsights").onclick = () => {
  document.getElementById("insightsModal").classList.add("hidden");
};


/* ---------------- LEADERBOARD PANEL ---------------- */
function openLeaderboard(stats) {
  const panel = document.getElementById("leaderboardPanel");
  const body = document.getElementById("leaderboardBody");

  body.innerHTML = stats
    .map((a, i) => `
      <div class="advisor-stat">
        <span>${i + 1}. ${a.advisor}</span>
        <span>$${a.labourGross.toLocaleString("en-AU")}</span>
      </div>
    `)
    .join("");

  panel.classList.remove("hidden");
}

document.getElementById("closeLeaderboard").onclick = () => {
  document.getElementById("leaderboardPanel").classList.add("hidden");
};


/* ======================================================
   MAIN RENDER PIPELINE
   ====================================================== */

function renderAll() {
  const daily = buildDailyMetrics();
  const mtd = buildMtdMetrics();
  const mix = buildMtdWorkMixAll();
  const rankmap = buildMtdRankMap();

  // GAUGES
  renderDailyGauges(daily);
  renderMtdGauges(mtd);

  // MIX TILES
  renderMixBar(document.getElementById("dailyMixContainer"), {
    retail: daily.retail,
    warranty: daily.warranty,
    internal: daily.internal,
    pctRetail:   daily.roCount ? (daily.retail / daily.roCount) * 100 : 0,
    pctWarranty: daily.roCount ? (daily.warranty / daily.roCount) * 100 : 0,
    pctInternal: daily.roCount ? (daily.internal / daily.roCount) * 100 : 0,
  });

  renderMixBar(document.getElementById("mtdMixContainer"), mix);

  // ADVISOR CARDS
  renderAdvisorCards(
    document.getElementById("dailyAdvisorList"),
    daily.advisorStats,
    rankmap.rankMap
  );

  renderAdvisorCards(
    document.getElementById("mtdAdvisorList"),
    mtd.advisorStats,
    rankmap.rankMap
  );
}


/* ---------------- DAILY GAUGE RENDER ---------------- */
function renderDailyGauges(d) {
  const grid = document.getElementById("dailyGaugeGrid");

  grid.innerHTML = `
    <div class="card gauge-card"><div id="dg1"></div></div>
    <div class="card gauge-card"><div id="dg2"></div></div>
    <div class="card gauge-card"><div id="dg3"></div></div>
    <div class="card gauge-card"><div id="dg4"></div></div>
  `;

  renderGauge(document.getElementById("dg1"), d.totalGross, SETTINGS.dailyLabourTarget, "Labour $");
  renderGauge(document.getElementById("dg2"), d.gpPct, 100, "GP%");
  renderGauge(document.getElementById("dg3"), d.avgGrossPerRO, 500, "Avg $/RO");
  renderGauge(document.getElementById("dg4"), d.billedRatio * 100, 100, "Charge Rate %");
}


/* ---------------- MTD GAUGE RENDER ---------------- */
function renderMtdGauges(d) {
  const grid = document.getElementById("mtdGaugeGrid");

  grid.innerHTML = `
    <div class="card gauge-card"><div id="mg1"></div></div>
    <div class="card gauge-card"><div id="mg2"></div></div>
    <div class="card gauge-card"><div id="mg3"></div></div>
    <div class="card gauge-card"><div id="mg4"></div></div>
  `;

  renderGauge(document.getElementById("mg1"), d.totalGross, SETTINGS.mtdLabourTarget, "Labour $");
  renderGauge(document.getElementById("mg2"), d.gpPct, 100, "GP%");
  renderGauge(document.getElementById("mg3"), d.avgGrossPerRO, 500, "Avg $/RO");
  renderGauge(document.getElementById("mg4"), d.billedRatio * 100, 100, "Charge Rate %");
}


/* ======================================================
   BUTTONS + UI WIRING
   ====================================================== */

// Tabs
document.getElementById("tabDashboard").onclick = () => {
  document.getElementById("page-dashboard").classList.remove("hidden");
  document.getElementById("page-settings").classList.add("hidden");
};

document.getElementById("tabSettings").onclick = () => {
  document.getElementById("page-dashboard").classList.add("hidden");
  document.getElementById("page-settings").classList.remove("hidden");
};


// Upload
document.getElementById("uploadBtn").onclick = () => {
  const input = document.getElementById("csvInput");
  if (input.files.length) {
    handleCsvUpload(input.files[0]);
  }
};

document.getElementById("loadOnlineBtn").onclick = () => {
  loadOnlineCsv();
};


// Settings save
document.getElementById("saveSettingsBtn").onclick = () => {
  SETTINGS.dailyLabourTarget = Number(document.getElementById("dailyLabourTarget").value);
  SETTINGS.mtdLabourTarget   = Number(document.getElementById("mtdLabourTarget").value);
  SETTINGS.onlineUrl = document.getElementById("onlineCsvUrl").value;

  SETTINGS.mode = document.getElementById("dataMode").value;

  // policy %
  document.querySelectorAll(".policy-input").forEach(x => {
    SETTINGS.policy[x.dataset.brand] = Number(x.value);
  });

  saveSettings();
  renderAll();
};


// Theme toggle
document.getElementById("toggleTheme").onclick = () => {
  document.body.classList.toggle("light");
};

</script>
<script>
/* ======================================================
   BLOCK 6 ‚Äî DYNAMIC INSIGHTS ENGINE
   Uses: buildDailyMetrics(), buildMtdMetrics(), buildMtdRankMap()
   DOM:  #insightsModal, #insightsBody
   ====================================================== */

(function () {
  function fmtMoney(v) {
    const n = Number(v) || 0;
    return "$" + n.toLocaleString("en-AU", {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });
  }

  function fmtMoney0(v) {
    const n = Number(v) || 0;
    return "$" + n.toLocaleString("en-AU", {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });
  }

  function fmtPercent(v) {
    const n = Number(v) || 0;
    return n.toFixed(1) + "%";
  }

  function safeFind(arr, name) {
    if (!Array.isArray(arr)) return null;
    return arr.find(a => a && a.advisor === name) || null;
  }

  function buildAdvisorInsightModel(name) {
    const daily = buildDailyMetrics();
    const mtd = buildMtdMetrics();
    const { rankMap, allStats } = buildMtdRankMap ? buildMtdRankMap() : { rankMap: {}, allStats: [] };

    const advDaily = safeFind(daily.advisorStats || [], name);
    const advMtd   = safeFind(mtd.advisorStats   || [], name);

    return {
      name,
      daily,
      mtd,
      advDaily,
      advMtd,
      rank: rankMap && rankMap[name] ? rankMap[name] : null,
      allStats: allStats || []
    };
  }

  function buildStory(model) {
    const { name, daily, mtd, advDaily, advMtd, rank, allStats } = model;
    const lines = [];

    // --- High-level status ---
    if (!advMtd && !advDaily) {
      lines.push(`<li>No recent activity found for <strong>${name}</strong> in the current period. Check if they are on leave, or if ROs are being allocated under a different advisor code.</li>`);
      return lines;
    }

    if (advMtd) {
      // MTD context vs team
      const teamAvgRO = mtd.roCount ? mtd.totalGross / mtd.roCount : 0;
      const teamAvgGp = mtd.gpPct || 0;

      // Rank / contribution
      if (rank) {
        lines.push(
          `<li><strong>MTD Position:</strong> ${name} is currently ranked <strong>#${rank}</strong> for labour gross with ` +
          `<strong>${fmtMoney(advMtd.labourGross)}</strong> across <strong>${advMtd.roCount}</strong> ROs.</li>`
        );
      } else {
        lines.push(
          `<li><strong>MTD Position:</strong> ${name} has MTD labour of <strong>${fmtMoney(advMtd.labourGross)}</strong> across ` +
          `<strong>${advMtd.roCount}</strong> ROs (not ranked in the main set).</li>`
        );
      }

      // Avg RO vs team
      if (teamAvgRO > 0) {
        const deltaRO = advMtd.avgRO - teamAvgRO;
        if (deltaRO >= 50) {
          lines.push(
            `<li><strong>Average RO value:</strong> ${name}'s average gross per RO is <strong>${fmtMoney0(advMtd.avgRO)}</strong>, ` +
            `which is about <strong>${fmtMoney0(deltaRO)}</strong> <em>above</em> the team average. Good opportunity to capture their upsell wording and menu structure.</li>`
          );
        } else if (deltaRO <= -50) {
          lines.push(
            `<li><strong>Average RO value:</strong> ${name}'s average gross per RO is <strong>${fmtMoney0(advMtd.avgRO)}</strong>, ` +
            `around <strong>${fmtMoney0(Math.abs(deltaRO))}</strong> <em>below</em> the team average. Focus coaching on pre-authorisation, option-building, and value-based recommendations.</li>`
          );
        } else {
          lines.push(
            `<li><strong>Average RO value:</strong> ${name}'s average gross per RO is <strong>${fmtMoney0(advMtd.avgRO)}</strong>, roughly in line with team average. ` +
            `Small tweaks to menu structure and tyre/battery/add-on conversations can unlock extra dollars.</li>`
          );
        }
      }

      // GP% vs team
      if (teamAvgGp > 0) {
        const deltaGp = advMtd.gpPct - teamAvgGp;
        if (deltaGp >= 2) {
          lines.push(
            `<li><strong>Margin control:</strong> GP% at <strong>${fmtPercent(advMtd.gpPct)}</strong> is above team average. ` +
            `This suggests good discount control and/or labour mix. Encourage them to share how they handle price objections without going straight to discounting.</li>`
          );
        } else if (deltaGp <= -2) {
          lines.push(
            `<li><strong>Margin control:</strong> GP% at <strong>${fmtPercent(advMtd.gpPct)}</strong> is below team average. ` +
            `Focus on scripts around 'labour is our expertise', avoiding premature discounts, and presenting value before price.</li>`
          );
        } else {
          lines.push(
            `<li><strong>Margin control:</strong> GP% at <strong>${fmtPercent(advMtd.gpPct)}</strong> is broadly in line with the department. ` +
            `Work more on volume (number of quality ROs) and menu-based upsell rather than margin changes.</li>`
          );
        }
      }

      // Leakage vs typical
      if (allStats.length > 0) {
        const avgLeak = allStats.reduce((sum, a) => sum + (a.leakagePct || 0), 0) / allStats.length;
        const leakDelta = advMtd.leakagePct - avgLeak;

        if (leakDelta >= 3) {
          lines.push(
            `<li><strong>Leakage (hours not billed):</strong> ${name}'s leakage is <strong>${fmtPercent(advMtd.leakagePct)}</strong>, ` +
            `around <strong>${fmtPercent(leakDelta)}</strong> higher than team typical. Highlight processes for ensuring all technician story-time and diag time is captured and authorised before work starts.</li>`
          );
        } else if (leakDelta <= -3) {
          lines.push(
            `<li><strong>Leakage (hours not billed):</strong> ${name}'s leakage is <strong>${fmtPercent(advMtd.leakagePct)}</strong>, ` +
            `which is significantly <em>better</em> than team typical. Use them as an example for RO building and time capture discipline.</li>`
          );
        } else {
          lines.push(
            `<li><strong>Leakage (hours not billed):</strong> Leakage at <strong>${fmtPercent(advMtd.leakagePct)}</strong> is close to team typical. ` +
            `Fine-tuning things like small additional operations, diagnosis time and clean-up can still free up a few extra billed hours.</li>`
          );
        }
      }
    }

    // --- Daily pulse (if any activity today) ---
    if (advDaily && daily.roCount > 0) {
      lines.push(
        `<li><strong>Today‚Äôs pulse:</strong> ${name} has closed <strong>${advDaily.roCount}</strong> ROs today with labour of ` +
        `<strong>${fmtMoney(advDaily.labourGross)}</strong> and average RO of <strong>${fmtMoney0(advDaily.avgRO)}</strong>. ` +
        `Use this in the huddle as a quick check-in: 'What worked well today? Where did you feel you left money on the table?'</li>`
      );

      if (advDaily.leakagePct > 10) {
        lines.push(
          `<li><strong>Immediate coaching opportunity:</strong> Today's leakage at <strong>${fmtPercent(advDaily.leakagePct)}</strong> ` +
          `suggests some technician time is not being converted to billed hours. Have a 5-minute debrief on one RO where time was lost and agree a better script for next time.</li>`
        );
      }
    }

    // --- Generic next actions ---
    lines.push(
      `<li><strong>Next steps with ${name}:</strong> Pick <em>one</em> primary focus for the next week (either average $/RO, leakage, or GP%) and build a micro-goal ` +
      `with them (e.g. <em>'3 extra meaningful recommendations per day'</em> or <em>'no unrecovered diag time'</em>). Review results in the dashboard each morning.</li>`
    );

    return lines;
  }

  // Override global openInsights used by the cards
  window.openInsights = function (name) {
    const modal = document.getElementById("insightsModal");
    const body  = document.getElementById("insightsBody");

    if (!modal || !body) return;

    const model = buildAdvisorInsightModel(name);
    const lines = buildStory(model);

    body.innerHTML = `
      <p><strong>Advisor:</strong> ${name}</p>
      <p>This summary looks at <strong>today</strong> and <strong>month-to-date</strong> performance using the current data set.</p>
      <ul>${lines.join("")}</ul>
      <p style="margin-top:8px; font-size:11px; opacity:0.8;">
        Use these points for your one-on-ones and morning huddles. Re-run the insights after key days to track behaviour change.
      </p>
    `;

    modal.classList.remove("hidden");
  };

  // Close handler (in case Block 5 hasn't already wired it)
  const closeBtn = document.getElementById("closeInsights");
  if (closeBtn && !closeBtn._novaBound) {
    closeBtn.addEventListener("click", () => {
      document.getElementById("insightsModal").classList.add("hidden");
    });
    closeBtn._novaBound = true;
  }
})();
</script>
