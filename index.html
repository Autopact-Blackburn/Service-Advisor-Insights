<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Advisor Performance ‚Äì Service Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PapaParse for CSV loading -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg: #050510;
      --bg-alt: #0b0b1a;
      --card: #111827;
      --card-soft: radial-gradient(circle at top left, #1f2937 0, #020617 60%);
      --accent: #00bcd4;
      --accent-soft: #00bcd466;
      --text: #f9fafb;
      --muted: #9ca3af;
      --border: #1f2937;
      --danger: #f97373;
      --success: #22c55e;
      --warning: #facc15;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.85);

      --mix-retail: #22c55e;
      --mix-warranty: #facc15;
      --mix-internal: #f97373;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top left, #111827 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .shell {
      width: min(1200px, 96%);
      margin: 20px auto 40px;
    }

    /* HEADER */

    header {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
    }

    .pulse-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 14px var(--accent-soft);
    }

    h1 {
      margin: 0;
      font-size: clamp(20px, 2.4vw, 26px);
      font-weight: 600;
    }

    .subtitle {
      font-size: 11px;
      color: var(--muted);
      max-width: 580px;
    }

    .header-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
    }

    select,
    input[type="date"] {
      background: #020617;
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 10px;
      font-size: 12px;
      color: var(--text);
      outline: none;
      min-width: 130px;
    }

    button {
      border: none;
      border-radius: 999px;
      font-size: 12px;
      padding: 8px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #020617;
      color: var(--text);
      border: 1px solid var(--border);
      transition: background 0.15s ease, transform 0.1s ease,
        box-shadow 0.15s ease;
    }

    button:hover {
      background: #020617;
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(15, 23, 42, 0.9);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #38bdf8);
      border-color: transparent;
      color: #020617;
      font-weight: 600;
      box-shadow: 0 10px 22px rgba(0, 188, 212, 0.5);
    }

    .btn-primary:hover {
      box-shadow: 0 14px 26px rgba(0, 188, 212, 0.7);
    }

    .icon-btn {
      width: 34px;
      height: 34px;
      justify-content: center;
      padding: 0;
      font-size: 16px;
    }

    @media (max-width: 640px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-controls {
        width: 100%;
        justify-content: flex-start;
      }
    }

    /* TOP TABS */

    .top-tabs {
      margin-top: 10px;
      margin-bottom: 10px;
      display: inline-flex;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
      padding: 4px;
    }

    .top-tab {
      border-radius: 999px;
      padding: 6px 18px;
      font-size: 12px;
      cursor: pointer;
      color: var(--muted);
      border: none;
      background: transparent;
      transition: background 0.15s ease, color 0.15s ease;
    }

    .top-tab.active {
      background: linear-gradient(135deg, #1f2937, #020617);
      color: #e5e7eb;
    }

    .section-title {
      margin: 16px 0 8px;
      font-size: 12px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
    }

    /* CARD BASE */

    .card {
      position: relative;
      background: var(--card-soft);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 12px 12px 14px;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 500;
    }

    .card-subtext {
      font-size: 11px;
      color: var(--muted);
    }

    .pill {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      color: var(--muted);
    }

    .pill.good {
      border-color: rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
      background: rgba(22, 163, 74, 0.18);
    }

    .pill.bad {
      border-color: rgba(248, 113, 113, 0.8);
      color: #fecaca;
      background: rgba(239, 68, 68, 0.16);
    }

    .pill.snapshot {
      border-color: rgba(148, 163, 184, 0.7);
      color: var(--muted);
      background: rgba(15, 23, 42, 0.8);
    }

    .loading {
      font-size: 11px;
      color: var(--muted);
    }

    .hidden {
      display: none !important;
    }

    /* GAUGE LAYOUT */

    .gauge-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    @media (max-width: 960px) {
      .gauge-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .gauge-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .gauge-card {
      background: var(--card-soft);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 10px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .gauge-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .gauge-title {
      font-size: 12px;
      font-weight: 500;
    }

    .gauge-sub {
      font-size: 11px;
      color: var(--muted);
    }

    .gauge-body {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .gauge-target {
      font-size: 10px;
      color: var(--muted);
    }

    .gauge-placeholder {
      font-size: 11px;
      color: var(--muted);
    }

    /* CIRCULAR GAUGE USING CSS CONIC GRADIENT */

    .circle-gauge {
      width: 90px;
      height: 90px;
      flex: 0 0 auto;
    }

    .circle-gauge-outer {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background:
        radial-gradient(circle at center, #020617 58%, transparent 60%),
        conic-gradient(
          var(--gauge-color, var(--accent)) calc(var(--value, 0) * 1turn),
          #111827 0
        );
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .circle-gauge-inner {
      width: 66%;
      height: 66%;
      border-radius: 50%;
      background: #020617;
      border: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
    }

    .circle-gauge-value {
      font-size: 12px;
      font-weight: 600;
    }

    .circle-gauge-pct {
      font-size: 10px;
      color: var(--muted);
    }

    /* MIX BAR */

    .mix-card {
      margin-top: 4px;
    }

    .mix-bar {
      position: relative;
      width: 100%;
      height: 18px;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(30, 64, 175, 0.7);
      margin-top: 6px;
      display: flex;
    }

    .mix-segment {
      height: 100%;
      display: inline-block;
    }

    .mix-retail {
      background: var(--mix-retail);
    }

    .mix-warranty {
      background: var(--mix-warranty);
    }

    .mix-internal {
      background: var(--mix-internal);
    }

    .mix-legend {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 10px;
      color: var(--muted);
    }

    .mix-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      display: inline-block;
      margin-right: 4px;
    }

    /* ADVISOR CARDS */

    .advisor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 10px;
    }

    .advisor-card {
      background: #020617;
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 10px 11px;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.15s ease,
        border-color 0.15s ease;
    }

    .advisor-card:hover {
      transform: translateY(-1px);
      border-color: rgba(148, 163, 184, 0.9);
      box-shadow: 0 10px 24px rgba(15, 23, 42, 0.9);
    }

    .advisor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }

    .advisor-name {
      font-size: 12px;
      font-weight: 500;
    }

    .advisor-rank {
      font-size: 10px;
      color: var(--muted);
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(51, 65, 85, 0.9);
      font-size: 10px;
      color: var(--muted);
    }

    /* LEADERBOARDS */

    .leaderboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 10px;
    }

    .lb-card {
      background: #020617;
      border-radius: 16px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      padding: 10px 11px;
      font-size: 11px;
    }

    .lb-title {
      font-size: 11px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .lb-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .lb-row span:first-child {
      color: var(--muted);
    }

    /* DATA SOURCE BAR */

    .data-source-bar {
      margin-top: 18px;
      padding: 10px 12px;
      border-radius: 14px;
      background: radial-gradient(circle at top left, #1f2937 0, #020617 75%);
      border: 1px solid rgba(148, 163, 184, 0.6);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: var(--muted);
    }

    .data-source-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .data-source-title {
      font-size: 12px;
      font-weight: 500;
      color: #e5e7eb;
    }

    .status-pill {
      font-size: 10px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--muted);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #64748b;
    }

    .status-pill.good .status-dot {
      background: #22c55e;
    }

    .status-pill.bad .status-dot {
      background: #ef4444;
    }

    .status-pill.good {
      border-color: rgba(34, 197, 94, 0.7);
      color: #bbf7d0;
    }

    .status-pill.bad {
      border-color: rgba(248, 113, 113, 0.8);
      color: #fecaca;
    }

    /* SETTINGS PAGE BASIC */

    .settings-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 10px;
    }

    @media (min-width: 840px) {
      .settings-grid {
        grid-template-columns: 2fr 1.4fr;
      }
    }

    .settings-field {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 11px;
    }

    .settings-field label {
      color: var(--muted);
      font-size: 11px;
    }

    .settings-field input,
    .settings-field select,
    .settings-field textarea {
      background: #020617;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 6px 8px;
      font-size: 11px;
      color: var(--text);
      outline: none;
    }

    .settings-group-title {
      font-size: 12px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    /* INSIGHTS MODAL */

    #advisorModal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.7);
      z-index: 50;
    }

    #advisorModal.hidden {
      display: none !important;
    }

    .modal-card {
      width: min(520px, 94%);
      max-height: 80vh;
      overflow-y: auto;
      background: #020617;
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 12px 14px;
      box-shadow: var(--shadow-soft);
      font-size: 11px;
      color: var(--muted);
    }

    .modal-section h3 {
      font-size: 11px;
      margin: 8px 0 4px;
      color: #e5e7eb;
    }

    .modal-section p {
      margin: 2px 0;
    }

    /* LEADERBOARD SIDE PANEL */

    #leaderboardPanel {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.7);
      display: flex;
      justify-content: flex-end;
      z-index: 40;
    }

    #leaderboardPanel.hidden {
      display: none !important;
    }

    .leaderboard-panel-inner {
      width: min(360px, 90%);
      background: #020617;
      border-left: 1px solid var(--border);
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #leaderboardPanelBody {
      font-size: 11px;
      color: var(--muted);
      overflow-y: auto;
      max-height: calc(100vh - 80px);
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- HEADER -->
    <header>
      <div class="title-block">
        <div class="badge">
          <span class="pulse-dot"></span>
          BLACKBURN KIA NISSAN GWM
        </div>
        <h1>Advisor Performance ‚Äì Service Dashboard</h1>
        <div class="subtitle">
          One export only: Advisor Summary Performance. Metrics are RO-based (unique InvoiceID), not line-based.
          Warranty / Internal / Customer mix is based on C / W / I closed dates.
        </div>
      </div>

      <div class="header-controls">
        <input type="date" id="datePicker" />
        <select id="advisorFilter">
          <option value="all">All Advisors (&gt;$1k MTD)</option>
        </select>
        <button id="leaderboardToggle">üèÜ Leaderboard</button>
        <button id="insightsBtn">‚ú® Insights</button>
        <button id="reloadOnlineBtn">üîÑ Reload Online Data</button>
      </div>
    </header>

    <!-- TABS -->
    <div class="top-tabs">
      <button class="top-tab active" data-page="dashboard">Dashboard</button>
      <button class="top-tab" data-page="settings">Settings</button>
    </div>

    <!-- DASHBOARD PAGE -->
    <div id="page-dashboard">
      <!-- TODAY GAUGES -->
      <div class="section-title">Today's performance</div>
      <div id="todaySummary" class="loading">
        Load CSV (manual or online) to see today's snapshot.
      </div>

      <div class="gauge-row">
        <!-- Today Labour -->
        <div class="gauge-card" id="todayGaugeLabour">
          <div class="gauge-header">
            <div class="gauge-title">Today Labour Gross</div>
            <span class="pill snapshot">Snapshot</span>
          </div>
          <div class="gauge-sub">All advisors ¬∑ closed ROs</div>
          <div class="gauge-body">
            <div class="circle-gauge">
              <div class="circle-gauge-outer" style="--value: 0;">
                <div class="circle-gauge-inner">
                  <div class="circle-gauge-value">$0</div>
                  <div class="circle-gauge-pct">0% of target</div>
                </div>
              </div>
            </div>
            <div class="gauge-target">
              Target: set in Settings
            </div>
          </div>
        </div>

        <!-- Today Avg RO -->
        <div class="gauge-card" id="todayGaugeAvgRo">
          <div class="gauge-header">
            <div class="gauge-title">Today Avg RO</div>
            <span class="pill snapshot">Snapshot</span>
          </div>
          <div class="gauge-sub">Approx labour per RO</div>
          <div class="gauge-body">
            <div class="circle-gauge">
              <div class="circle-gauge-outer" style="--value: 0;">
                <div class="circle-gauge-inner">
                  <div class="circle-gauge-value">$0</div>
                  <div class="circle-gauge-pct">0% of target</div>
                </div>
              </div>
            </div>
            <div class="gauge-target">
              Target: set in Settings
            </div>
          </div>
        </div>

        <!-- Today Hours -->
        <div class="gauge-card" id="todayGaugeHours">
          <div class="gauge-header">
            <div class="gauge-title">Hours Sold / Clocked</div>
            <span class="pill snapshot">Snapshot</span>
          </div>
          <div class="gauge-sub">Technician hours for today</div>
          <div class="gauge-body">
            <div class="circle-gauge">
              <div class="circle-gauge-outer" style="--value: 0;">
                <div class="circle-gauge-inner">
                  <div class="circle-gauge-value">0.0%</div>
                  <div class="circle-gauge-pct">Leakage</div>
                </div>
              </div>
            </div>
            <div class="gauge-target">
              Goal: set in Settings (e.g. 100% billed)
            </div>
          </div>
        </div>
      </div>

      <!-- MTD GAUGES -->
      <div class="section-title">Month-to-date performance</div>
      <div id="mtdSummary" class="loading">
        Load CSV to see MTD summary.
      </div>

      <div class="gauge-row">
        <!-- MTD Labour -->
        <div class="gauge-card" id="mtdGaugeLabour">
          <div class="gauge-header">
            <div class="gauge-title">MTD Labour Gross</div>
            <span class="pill snapshot">Snapshot</span>
          </div>
          <div class="gauge-sub">All advisors ¬∑ MTD closed ROs</div>
          <div class="gauge-body">
            <div class="circle-gauge">
              <div class="circle-gauge-outer" style="--value: 0;">
                <div class="circle-gauge-inner">
                  <div class="circle-gauge-value">$0</div>
                  <div class="circle-gauge-pct">0% of target</div>
                </div>
              </div>
            </div>
            <div class="gauge-target">
              Target: set in Settings
            </div>
          </div>
        </div>

        <!-- MTD Avg RO -->
        <div class="gauge-card" id="mtdGaugeAvgRo">
          <div class="gauge-header">
            <div class="gauge-title">MTD Avg RO</div>
            <span class="pill snapshot">Snapshot</span>
          </div>
          <div class="gauge-sub">Approx labour per RO ¬∑ month</div>
          <div class="gauge-body">
            <div class="circle-gauge">
              <div class="circle-gauge-outer" style="--value: 0;">
                <div class="circle-gauge-inner">
                  <div class="circle-gauge-value">$0</div>
                  <div class="circle-gauge-pct">0% of target</div>
                </div>
              </div>
            </div>
            <div class="gauge-target">
              Target: set in Settings
            </div>
          </div>
        </div>

        <!-- MTD GP% -->
        <div class="gauge-card" id="mtdGaugeGp">
          <div class="gauge-header">
            <div class="gauge-title">MTD GP%</div>
            <span class="pill snapshot">Snapshot</span>
          </div>
          <div class="gauge-sub">Margin on labour gross</div>
          <div class="gauge-body">
            <div class="circle-gauge">
              <div class="circle-gauge-outer" style="--value: 0;">
                <div class="circle-gauge-inner">
                  <div class="circle-gauge-value">0.0%</div>
                  <div class="circle-gauge-pct">vs target</div>
                </div>
              </div>
            </div>
            <div class="gauge-target">
              Target: set in Settings
            </div>
          </div>
        </div>
      </div>

      <!-- MIX BAR -->
      <div class="section-title">Customer / Warranty / Internal mix (MTD)</div>
      <div class="card mix-card">
        <div class="card-header">
          <span class="card-title">RO Mix by type (all advisors)</span>
          <span class="pill snapshot" id="mixStatusPill">Snapshot</span>
        </div>
        <div class="card-subtext" id="mixCountsLabel">
          Retail 0 ¬∑ Warranty 0 ¬∑ Internal 0 ¬∑ Total 0
        </div>
        <div class="mix-bar" id="mixBar"></div>
        <div class="mix-legend" id="mixLegend">
          <span><span class="mix-dot" style="background:var(--mix-retail);"></span>Retail (Customer-pay)</span>
          <span><span class="mix-dot" style="background:var(--mix-warranty);"></span>Warranty</span>
          <span><span class="mix-dot" style="background:var(--mix-internal);"></span>Internal</span>
        </div>
      </div>

      <!-- ADVISOR PERFORMANCE -->
      <div class="section-title">Advisor performance</div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">Advisor cards ‚Äì Today &amp; MTD</span>
          <span class="card-subtext" id="advisorFilterNote">
            Filtered by advisors with &gt;$1k MTD labour (ghost advisors removed).
          </span>
        </div>
        <div class="advisor-grid" id="advisorCards">
          <div class="loading">Load CSV to see advisor performance.</div>
        </div>
      </div>

      <!-- LEADERBOARDS -->
      <div class="section-title">Leaderboards &amp; key indicators</div>
      <div class="leaderboard-grid" id="leaderboardCards">
        <div class="lb-card">
          <div class="lb-title">Top 5 Labour Gross</div>
          <div class="loading">Will populate once CSV is loaded.</div>
        </div>
        <div class="lb-card">
          <div class="lb-title">Top 5 Avg RO</div>
          <div class="loading">Will populate once CSV is loaded.</div>
        </div>
        <div class="lb-card">
          <div class="lb-title">Top 5 GP%</div>
          <div class="loading">Will populate once CSV is loaded.</div>
        </div>
      </div>

      <!-- DATA SOURCE BAR -->
      <div class="data-source-bar">
        <div class="data-source-left">
          <div class="data-source-title">Data source</div>
          <div>Use the Advisor Summary export (one row per RO). CSV can be loaded from an online link or manual upload.</div>
        </div>
        <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
          <input type="file" id="fileInput" accept=".csv" class="hidden" />
          <button id="btnUpload" class="btn-primary">DETAIL DATA (CSV)</button>
          <button id="btnOnlineLoad">üåê Load Online CSV</button>
          <div id="statusTotal" class="status-pill bad">
            <span class="status-dot"></span>
            <span>CSV not loaded</span>
          </div>
        </div>
      </div>

      <!-- ONLINE CSV SOURCE CARD -->
      <div class="section-title">Online CSV source</div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">Google Sheets CSV link</span>
        </div>
        <div style="margin-top:6px; font-size:11px; color:var(--muted);">
          Paste Google Sheets CSV link. This will be used when "Load Online CSV" or "Reload Online Data" is clicked.
        </div>
        <input
          id="onlineCsvUrl"
          type="text"
          style="margin-top:8px; width:100%; padding:8px; border-radius:8px; border:1px solid var(--border); background:#020617; color:var(--text); font-size:11px;"
          value="https://docs.google.com/spreadsheets/d/1fiwosf8gXN6faN-LHQtvAIfMbAagEptqWkwiPE23Vbg/export?format=csv"
        />
        <div id="onlineStatus" style="margin-top:6px; font-size:11px; color:var(--muted);">
          Waiting for first load.
        </div>
      </div>
    </div>

    <!-- SETTINGS PAGE -->
    <div id="page-settings" class="hidden">
      <div class="section-title">Settings</div>
      <div class="settings-grid">
        <!-- Targets -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">Targets</span>
          </div>
          <div class="card-subtext">
            Configure daily and MTD targets for gauges. These will be stored in localStorage.
          </div>

          <div class="settings-field">
            <label for="dailyLabourTarget">Daily Labour Gross Target ($)</label>
            <input type="number" id="dailyLabourTarget" />
          </div>
          <div class="settings-field">
            <label for="dailyAvgRoTarget">Daily Avg RO Target ($)</label>
            <input type="number" id="dailyAvgRoTarget" />
          </div>
          <div class="settings-field">
            <label for="dailyHoursRatioTarget">Hours Sold / Clocked Target (e.g. 1.0 = 100%)</label>
            <input type="number" step="0.01" id="dailyHoursRatioTarget" />
          </div>
          <hr style="border:0;border-top:1px solid rgba(31,41,55,0.8);margin:8px 0;" />
          <div class="settings-field">
            <label for="mtdLabourTarget">MTD Labour Gross Target ($)</label>
            <input type="number" id="mtdLabourTarget" />
          </div>
          <div class="settings-field">
            <label for="mtdAvgRoTarget">MTD Avg RO Target ($)</label>
            <input type="number" id="mtdAvgRoTarget" />
          </div>
          <div class="settings-field">
            <label for="mtdGpPctTarget">MTD GP% Target</label>
            <input type="number" id="mtdGpPctTarget" />
          </div>
          <div class="settings-field">
            <label for="nonRetailMaxPct">Max Warranty + Internal % of total ROs</label>
            <input type="number" id="nonRetailMaxPct" />
          </div>

          <div style="margin-top:10px; display:flex; gap:8px;">
            <button id="btnSaveSettings" class="btn-primary">Save Settings</button>
            <button id="btnResetSettings">Reset to Defaults</button>
          </div>
        </div>

        <!-- Data source mode + notes -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">Data source mode</span>
          </div>
          <div class="card-subtext">
            Choose whether to default to the online Google Sheets CSV or manual upload.
          </div>

          <div class="settings-field">
            <label for="dataSourceMode">Default data source</label>
            <select id="dataSourceMode">
              <option value="online">Online (Google Sheets CSV)</option>
              <option value="manual">Manual upload</option>
            </select>
          </div>

          <div class="settings-field">
            <label for="settingsOnlineUrl">Online CSV URL (same as above)</label>
            <textarea id="settingsOnlineUrl" rows="4"></textarea>
          </div>

          <div class="settings-field">
            <label>Notes</label>
            <div style="font-size:11px; color:var(--muted);">
              This panel just controls defaults and targets. Data is never sent anywhere ‚Äì everything runs in-browser.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- INSIGHTS MODAL -->
  <div id="advisorModal" class="hidden">
    <div class="modal-card">
      <div class="card-header" style="padding:0; margin-bottom:6px;">
        <span class="card-title">Service Advisor Insights</span>
        <span class="pill snapshot" id="modalDateLabel">Snapshot</span>
      </div>
      <div id="advisorModalBody" class="modal-section">
        <p class="loading">Select an advisor card to view insights, or click ‚ú® Insights for a global summary.</p>
      </div>
      <div style="margin-top:10px; display:flex; justify-content:flex-end; gap:8px;">
        <button id="advisorModalClose">Close</button>
      </div>
    </div>
  </div>

  <!-- LEADERBOARD SIDE PANEL -->
  <div id="leaderboardPanel" class="hidden">
    <div class="leaderboard-panel-inner">
      <div class="card-header" style="padding:0;">
        <span class="card-title">Advisor Leaderboard</span>
        <button id="closeLeaderboard" class="icon-btn">‚úï</button>
      </div>
      <div id="leaderboardPanelBody">
        <div class="loading">Will populate once CSV is loaded.</div>
      </div>
    </div>
  </div>

  <!-- BLOCK 2 / 3 / 4 SCRIPTS BELOW -->
  <script>
  // ======================================================
  // BLOCK 2 ‚Äî STATE, SETTINGS, UTILITIES, METRIC BUILDERS
  // ======================================================

  // ------------ STATE ------------
  const state = {
    rows: [],
    loaded: false,
    filters: {
      date: null,
      advisor: "all"
    }
  };

  // ------------ SETTINGS ------------
  const SETTINGS_KEY = "advisorDashSettings_v5";

  const defaultSettings = {
    // Daily targets
    dailyLabourTarget: 17000,
    dailyAvgRoTarget: 410,
    dailyHoursRatioTarget: 1.0, // 100%

    // MTD targets
    mtdLabourTarget: 390000,
    mtdAvgRoTarget: 430,
    mtdGpPctTarget: 80,

    // Mix expectations
    nonRetailMaxPct: 20,

    // Data source defaults
    dataSourceMode: "online",
    onlineCsvUrl:
      "https://docs.google.com/spreadsheets/d/1fiwosf8gXN6faN-LHQtvAIfMbAagEptqWkwiPE23Vbg/export?format=csv"
  };

  let settings = { ...defaultSettings };

  function loadSettings() {
    try {
      const raw = localStorage.getItem(SETTINGS_KEY);
      if (!raw) return;
      const parsed = JSON.parse(raw);
      settings = { ...defaultSettings, ...parsed };
    } catch (e) {
      console.warn("Failed to load settings, using defaults.", e);
      settings = { ...defaultSettings };
    }
  }

  function saveSettings() {
    try {
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    } catch (e) {
      console.warn("Failed to save settings.", e);
    }
  }

  // ------------ UTILITIES ------------

  function parseAuDate(str) {
    if (!str || typeof str !== "string") return null;
    const trimmed = str.trim();
    if (!trimmed) return null;

    // dd/mm/yyyy or dd-mm-yyyy
    const m = trimmed.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
    if (m) {
      let d = parseInt(m[1], 10);
      let mth = parseInt(m[2], 10);
      let y = parseInt(m[3], 10);
      if (y < 100) y += 2000;
      const dt = new Date(y, mth - 1, d);
      return isNaN(dt.getTime()) ? null : dt;
    }

    // yyyy-mm-dd
    const m2 = trimmed.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if (m2) {
      let y = parseInt(m2[1], 10);
      let mth = parseInt(m2[2], 10);
      let d = parseInt(m2[3], 10);
      const dt = new Date(y, mth - 1, d);
      return isNaN(dt.getTime()) ? null : dt;
    }

    const dt = new Date(trimmed);
    return isNaN(dt.getTime()) ? null : dt;
  }

  function sameDay(d1, d2) {
    return (
      d1.getFullYear() === d2.getFullYear() &&
      d1.getMonth() === d2.getMonth() &&
      d1.getDate() === d2.getDate()
    );
  }

  function sameMonth(d1, d2) {
    return (
      d1.getFullYear() === d2.getFullYear() &&
      d1.getMonth() === d2.getMonth()
    );
  }

  function toNumber(v) {
    if (typeof v === "number" && isFinite(v)) return v;
    if (v === null || v === undefined) return 0;
    const cleaned = String(v).replace(/[^0-9.\-]/g, "");
    const num = parseFloat(cleaned);
    return isNaN(num) ? 0 : num;
  }

  function formatCurrency(v) {
    return "$" + toNumber(v).toLocaleString("en-AU", {
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    });
  }

  function formatPercent(v) {
    return toNumber(v).toFixed(1) + "%";
  }

  const uniq = arr => [...new Set(arr)];

  // ------------ COLUMN HELPERS ------------

  function getCloseDate(row) {
    const c = parseAuDate(row["C Closed Date"]);
    const w = parseAuDate(row["W Closed Date"]);
    const i = parseAuDate(row["I Closed Date"]);
    const invClosed = parseAuDate(row["Inv Closed Date"]);
    const invOpen = parseAuDate(row["Inv Open Date"]);
    return c || w || i || invClosed || invOpen || null;
  }

  function classifyRoType(row) {
    if (row["I Closed Date"]) return "internal";
    if (row["W Closed Date"]) return "warranty";
    if (row["C Closed Date"]) return "customer";
    return "unknown";
  }

  function getGross(row) {
    const g = toNumber(row["Gross"]);
    if (g !== 0) return g;

    const sale = toNumber(row["Sale"]);
    const cost = toNumber(row["Cost"]);
    if (sale || cost) return sale - cost;

    return 0;
  }

  function getCost(row) {
    const c = toNumber(row["Cost"]);
    if (c !== 0) return c;
    return (
      toNumber(row["Cost (Open)"]) +
      toNumber(row["Cost (Labour)"]) +
      toNumber(row["Cost (Parts)"])
    );
  }

  function getChargedHours(row) {
    return toNumber(row["Charged Hrs"]);
  }

  function getClockedHours(row) {
    return toNumber(row["Clocked Hrs"]);
  }

  // ------------ DATA PREPARATION AFTER LOAD ------------

  function buildAdvisorStats(rows) {
    const map = {};

    rows.forEach(r => {
      const name = String(r["Advisor Name"] || "").trim() || "Unknown";
      if (!map[name]) {
        map[name] = {
          advisor: name,
          labourGross: 0,
          cost: 0,
          roCount: 0,
          chargedHrs: 0,
          clockedHrs: 0
        };
      }

      map[name].labourGross += getGross(r);
      map[name].cost += getCost(r);
      map[name].roCount += 1;
      map[name].chargedHrs += getChargedHours(r);
      map[name].clockedHrs += getClockedHours(r);
    });

    const list = Object.values(map);

    list.forEach(a => {
      a.avgRo = a.roCount ? a.labourGross / a.roCount : 0;
      a.gpPct = a.labourGross
        ? ((a.labourGross - a.cost) / a.labourGross) * 100
        : 0;
      a.hoursRatio = a.clockedHrs
        ? a.chargedHrs / a.clockedHrs
        : 0;
      a.leakagePct = 100 - (a.hoursRatio * 100);
    });

    list.sort((a, b) => b.labourGross - a.labourGross);
    return list;
  }

  // ------------ METRICS: TODAY ------------
  function computeTodayMetrics() {
    const base = state.filters.date || new Date();
    const todayRows = state.rows.filter(r => {
      const d = getCloseDate(r);
      return d && sameDay(d, base);
    });

    const stats = buildAdvisorStats(todayRows);

    let totalGross = 0;
    let totalCost = 0;
    let chargedHrs = 0;
    let clockedHrs = 0;
    let retail = 0;
    let warranty = 0;
    let internal = 0;

    todayRows.forEach(r => {
      totalGross += getGross(r);
      totalCost += getCost(r);
      chargedHrs += getChargedHours(r);
      clockedHrs += getClockedHours(r);

      const type = classifyRoType(r);
      if (type === "customer") retail++;
      if (type === "warranty") warranty++;
      if (type === "internal") internal++;
    });

    return {
      rows: todayRows,
      advisorStats: stats,
      roCount: todayRows.length,
      totalGross,
      totalCost,
      chargedHrs,
      clockedHrs,
      retail,
      warranty,
      internal
    };
  }

  // ------------ METRICS: MTD ------------
  function computeMtdMetrics() {
    const base = state.filters.date || new Date();
    const mtdRows = state.rows.filter(r => {
      const d = getCloseDate(r);
      return d && sameMonth(d, base);
    });

    const statsRaw = buildAdvisorStats(mtdRows);
    const stats = statsRaw.filter(a => a.labourGross >= 1000);

    const rankMap = {};
    stats
      .slice()
      .sort((a, b) => b.labourGross - a.labourGross)
      .forEach((a, i) => (rankMap[a.advisor] = i + 1));

    let totalGross = 0;
    let totalCost = 0;
    let chargedHrs = 0;
    let clockedHrs = 0;
    let retail = 0;
    let warranty = 0;
    let internal = 0;

    mtdRows.forEach(r => {
      totalGross += getGross(r);
      totalCost += getCost(r);
      chargedHrs += getChargedHours(r);
      clockedHrs += getClockedHours(r);

      const type = classifyRoType(r);
      if (type === "customer") retail++;
      if (type === "warranty") warranty++;
      if (type === "internal") internal++;
    });

    const gpPct = totalGross
      ? ((totalGross - totalCost) / totalGross) * 100
      : 0;

    const avgRo = mtdRows.length ? totalGross / mtdRows.length : 0;

    return {
      rows: mtdRows,
      advisorStats: stats,
      rankMap,
      roCount: mtdRows.length,
      totalGross,
      totalCost,
      chargedHrs,
      clockedHrs,
      retail,
      warranty,
      internal,
      gpPct,
      avgRo
    };
  }

  // ------------ METRICS: MIX (ALL ADVISORS, MTD) ------------
  function computeMtdMixAll() {
    const base = state.filters.date || new Date();
    const mtdRows = state.rows.filter(r => {
      const d = getCloseDate(r);
      return d && sameMonth(d, base);
    });

    let retail = 0,
      warranty = 0,
      internal = 0;

    mtdRows.forEach(r => {
      const t = classifyRoType(r);
      if (t === "customer") retail++;
      if (t === "warranty") warranty++;
      if (t === "internal") internal++;
    });

    const total = retail + warranty + internal;

    return {
      retail,
      warranty,
      internal,
      total,
      retailPct: total ? (retail / total) * 100 : 0,
      warrantyPct: total ? (warranty / total) * 100 : 0,
      internalPct: total ? (internal / total) * 100 : 0
    };
  }

  // alias name used elsewhere
  function computeMtdMixAllAdvisors() {
    return computeMtdMixAll();
  }

  // ------------ DATE + ADVISOR FILTER INIT ------------

  function initDateFromData() {
    if (!state.rows.length) return;
    const dates = state.rows
      .map(r => getCloseDate(r))
      .filter(Boolean)
      .sort((a, b) => a - b);

    if (!dates.length) return;

    const latest = dates[dates.length - 1];
    state.filters.date = latest;

    const picker = document.getElementById("datePicker");
    if (picker) {
      const y = latest.getFullYear();
      const m = String(latest.getMonth() + 1).padStart(2, "0");
      const d = String(latest.getDate()).padStart(2, "0");
      picker.value = `${y}-${m}-${d}`;
    }
  }

  function initAdvisorFilter() {
    const select = document.getElementById("advisorFilter");
    if (!select) return;
    select.innerHTML = "";

    const optAll = document.createElement("option");
    optAll.value = "all";
    optAll.textContent = "All Advisors (> $1k MTD)";
    select.appendChild(optAll);

    const mtd = computeMtdMetrics();
    const advisors = mtd.advisorStats
      .slice()
      .sort((a, b) => a.advisor.localeCompare(b.advisor));

    advisors.forEach(a => {
      const opt = document.createElement("option");
      opt.value = a.advisor;
      opt.textContent = a.advisor;
      select.appendChild(opt);
    });
  }
  </script>
  <script>
  // ======================================================
  // BLOCK 3 ‚Äî RENDER ENGINE (GAUGES, MIX BAR, CARDS, LEADERBOARDS)
  // ======================================================

  function byId(id) {
    return document.getElementById(id);
  }

  function el(tag, cls, txt) {
    const e = document.createElement(tag);
    if (cls) e.className = cls;
    if (txt !== undefined) e.textContent = txt;
    return e;
  }

  // ----- CIRCULAR GAUGE USING EXISTING .circle-gauge MARKUP -----
  function buildCircleGauge(valueLabel, pctLabel, pct, colorVar) {
    const wrap = el("div", "circle-gauge");
    const outer = el("div", "circle-gauge-outer");
    const inner = el("div", "circle-gauge-inner");
    const valEl = el("div", "circle-gauge-value", valueLabel);
    const pctEl = el("div", "circle-gauge-pct", pctLabel);

    const frac = Math.max(0, Math.min(100, pct)) / 100;
    outer.style.setProperty("--value", String(frac));
    if (colorVar) {
      outer.style.setProperty("--gauge-color", colorVar);
    }

    inner.appendChild(valEl);
    inner.appendChild(pctEl);
    outer.appendChild(inner);
    wrap.appendChild(outer);
    return wrap;
  }

  function renderGaugeCurrency(cardId, label, subtitle, value, target) {
    const card = byId(cardId);
    if (!card) return;

    const pct = target > 0 ? Math.max(0, Math.min(100, (value / target) * 100)) : 0;

    card.innerHTML = "";

    const header = el("div", "gauge-header");
    const title = el("div", "gauge-title", label);
    const pill = el("span", "pill snapshot", "Snapshot");
    header.appendChild(title);
    header.appendChild(pill);

    const sub = el("div", "gauge-sub", subtitle);

    const body = el("div", "gauge-body");
    const gauge = buildCircleGauge(
      formatCurrency(value),
      target ? pct.toFixed(0) + "% of target" : "No target",
      pct,
      null
    );

    const targetEl = el(
      "div",
      "gauge-target",
      target ? `Target: ${formatCurrency(target)}` : "Target: not set"
    );

    body.appendChild(gauge);
    body.appendChild(targetEl);

    card.appendChild(header);
    card.appendChild(sub);
    card.appendChild(body);
  }

  function renderGaugeNumber(cardId, label, subtitle, value, target, unitLabel, isPercentGauge = false) {
    const card = byId(cardId);
    if (!card) return;

    const pct = target > 0 ? Math.max(0, Math.min(100, (value / target) * 100)) : 0;

    card.innerHTML = "";

    const header = el("div", "gauge-header");
    const title = el("div", "gauge-title", label);
    const pill = el("span", "pill snapshot", "Snapshot");
    header.appendChild(title);
    header.appendChild(pill);

    const sub = el("div", "gauge-sub", subtitle);

    const body = el("div", "gauge-body");

    const displayValue = isPercentGauge
      ? value.toFixed(1) + "%"
      : value.toFixed(0) + (unitLabel || "");

    const gauge = buildCircleGauge(
      displayValue,
      target ? pct.toFixed(0) + "% of target" : "No target",
      pct,
      isPercentGauge ? "var(--warning)" : null
    );

    const targetEl = el(
      "div",
      "gauge-target",
      target
        ? `Target: ${isPercentGauge ? target.toFixed(1) + "%" : target.toFixed(0) + (unitLabel || "")}`
        : "Target: not set"
    );

    body.appendChild(gauge);
    body.appendChild(targetEl);

    card.appendChild(header);
    card.appendChild(sub);
    card.appendChild(body);
  }

  // ----- MIX BAR -----
  function renderMixBar(mix) {
    const bar = byId("mixBar");
    const label = byId("mixCountsLabel");
    const legend = byId("mixLegend");
    const pill = byId("mixStatusPill");

    if (!bar || !label || !legend) return;

    bar.innerHTML = "";
    legend.innerHTML = "";

    if (!mix.total) {
      label.textContent = "No MTD data";
      if (pill) {
        pill.classList.remove("good", "bad");
        pill.textContent = "No data";
      }
      return;
    }

    const segRetail = el("div", "mix-segment mix-retail");
    segRetail.style.width = mix.retailPct + "%";
    bar.appendChild(segRetail);

    const segWarranty = el("div", "mix-segment mix-warranty");
    segWarranty.style.width = mix.warrantyPct + "%";
    bar.appendChild(segWarranty);

    const segInternal = el("div", "mix-segment mix-internal");
    segInternal.style.width = mix.internalPct + "%";
    bar.appendChild(segInternal);

    label.textContent =
      `Customer ${mix.retail} ¬∑ Warranty ${mix.warranty} ¬∑ Internal ${mix.internal} ¬∑ Total ${mix.total}`;

    const lg1 = el("span");
    lg1.innerHTML = `<span class="mix-dot" style="background:var(--mix-retail);"></span>Retail (Customer-pay)`;
    legend.appendChild(lg1);

    const lg2 = el("span");
    lg2.innerHTML = `<span class="mix-dot" style="background:var(--mix-warranty);"></span>Warranty`;
    legend.appendChild(lg2);

    const lg3 = el("span");
    lg3.innerHTML = `<span class="mix-dot" style="background:var(--mix-internal);"></span>Internal`;
    legend.appendChild(lg3);

    if (pill) {
      pill.classList.remove("good", "bad");
      const nonRetailPct = mix.warrantyPct + mix.internalPct;
      if (nonRetailPct <= (toNumber(settings.nonRetailMaxPct) || 20)) {
        pill.classList.add("good");
        pill.textContent = "Mix OK";
      } else {
        pill.classList.add("bad");
        pill.textContent = "Mix high non-retail";
      }
    }
  }

  // ----- ADVISOR CARDS -----
  function renderAdvisorCards(stats, rankMap) {
    const container = byId("advisorCards");
    if (!container) return;

    container.innerHTML = "";
    if (!stats.length) {
      container.innerHTML = `<div class="loading">No advisor data for this period.</div>`;
      return;
    }

    stats.forEach(a => {
      const card = el("div", "advisor-card");
      card.addEventListener("click", () => {
        openAdvisorInsights(a, rankMap);
      });

      const header = el("div", "advisor-header");
      const name = el("div", "advisor-name", a.advisor);
      const rank = el("div", "advisor-rank", "#" + (rankMap[a.advisor] || "-"));
      header.appendChild(name);
      header.appendChild(rank);

      const chips = el("div", "chip-row");
      const chipGross = el("div", "chip", "Gross " + formatCurrency(a.labourGross));
      const chipAvgRo = el("div", "chip", "Avg RO " + formatCurrency(a.avgRo));
      const chipGp = el("div", "chip", "GP " + a.gpPct.toFixed(1) + "%");
      const chipLeak = el("div", "chip", "Leakage " + a.leakagePct.toFixed(1) + "%");

      chips.appendChild(chipGross);
      chips.appendChild(chipAvgRo);
      chips.appendChild(chipGp);
      chips.appendChild(chipLeak);

      card.appendChild(header);
      card.appendChild(chips);

      container.appendChild(card);
    });
  }

  // ----- LEADERBOARDS (MAIN GRID + SIDE PANEL) -----
  function renderLeaderboards(mtdStats) {
    const grid = byId("leaderboardCards");
    const panelBody = byId("leaderboardPanelBody");
    if (!grid) return;

    grid.innerHTML = "";

    if (!mtdStats.length) {
      grid.innerHTML =
        `<div class="lb-card"><div class="lb-title">Leaderboards</div><div class="loading">No data loaded.</div></div>`;
      if (panelBody) {
        panelBody.innerHTML = `<div class="loading">No data loaded.</div>`;
      }
      return;
    }

    const clones = mtdStats.slice();

    const cards = [
      {
        title: "Top 5 Labour Gross (MTD)",
        list: clones.slice().sort((a, b) => b.labourGross - a.labourGross),
        format: a => formatCurrency(a.labourGross)
      },
      {
        title: "Top 5 Avg RO (MTD)",
        list: clones.slice().sort((a, b) => b.avgRo - a.avgRo),
        format: a => formatCurrency(a.avgRo)
      },
      {
        title: "Top 5 GP% (MTD)",
        list: clones.slice().sort((a, b) => b.gpPct - a.gpPct),
        format: a => a.gpPct.toFixed(1) + "%"
      }
    ];

    cards.forEach(cardData => {
      const card = el("div", "lb-card");
      const title = el("div", "lb-title", cardData.title);
      card.appendChild(title);

      cardData.list.slice(0, 5).forEach((a, idx) => {
        const row = el("div", "lb-row");
        const left = el("span", "", `${idx + 1}. ${a.advisor}`);
        const right = el("span", "", cardData.format(a));
        row.appendChild(left);
        row.appendChild(right);
        card.appendChild(row);
      });

      grid.appendChild(card);
    });

    if (panelBody) {
      panelBody.innerHTML = "";

      const heading = el("div", "lb-title", "Full advisor list (by gross)");
      panelBody.appendChild(heading);

      clones
        .sort((a, b) => b.labourGross - a.labourGross)
        .forEach((a, idx) => {
          const row = el("div", "lb-row");
          const left = el("span", "", `${idx + 1}. ${a.advisor}`);
          const right = el(
            "span",
            "",
            `${formatCurrency(a.labourGross)} ¬∑ Avg RO ${formatCurrency(a.avgRo)} ¬∑ GP ${a.gpPct.toFixed(1)}%`
          );
          row.appendChild(left);
          row.appendChild(right);
          panelBody.appendChild(row);
        });
    }
  }

  // ----- ADVISOR INSIGHTS MODAL (PER ADVISOR) -----
  function openAdvisorInsights(a, rankMap) {
    const modal = byId("advisorModal");
    const body = byId("advisorModalBody");
    const dateLbl = byId("modalDateLabel");
    const closeBtn = byId("advisorModalClose");

    if (!modal || !body) return;

    const today = state.filters.date || new Date();
    const y = today.getFullYear();
    const m = String(today.getMonth() + 1).padStart(2, "0");
    const d = String(today.getDate()).padStart(2, "0");
    if (dateLbl) dateLbl.textContent = `${d}/${m}/${y}`;

    body.innerHTML = `
      <div><strong>${a.advisor}</strong></div>
      <div>Rank: #${rankMap[a.advisor] || "-"}</div>
      <div>Total Gross: ${formatCurrency(a.labourGross)}</div>
      <div>Avg RO: ${formatCurrency(a.avgRo)}</div>
      <div>GP%: ${a.gpPct.toFixed(1)}%</div>
      <div>Hours Ratio: ${(a.hoursRatio * 100).toFixed(1)}%</div>
      <div>Leakage: ${a.leakagePct.toFixed(1)}%</div>
      <hr style="border:0;border-top:1px solid rgba(31,41,55,0.8);margin:6px 0;" />
      <p style="margin-top:4px;">
        Use this as a coaching conversation: celebrate today's wins, then align on 1‚Äì2 specific actions
        (follow-up calls, upsell scripts, better RO story, etc.).
      </p>
    `;

    modal.classList.remove("hidden");

    if (closeBtn) {
      closeBtn.onclick = () => modal.classList.add("hidden");
    }

    modal.addEventListener("click", e => {
      if (e.target === modal) modal.classList.add("hidden");
    });
  }
  </script>
  <script>
  // ======================================================
  // BLOCK 4 ‚Äî APP ENGINE (LOAD + FILTER + RENDER)
  // ======================================================

  function renderDashboard() {
    const todaySummaryEl = byId("todaySummary");
    const mtdSummaryEl = byId("mtdSummary");

    if (!state.loaded || !state.rows.length) {
      if (todaySummaryEl) todaySummaryEl.textContent = "CSV not loaded.";
      if (mtdSummaryEl) mtdSummaryEl.textContent = "CSV not loaded.";

      ["todayGaugeLabour", "todayGaugeAvgRo", "todayGaugeHours",
       "mtdGaugeLabour", "mtdGaugeAvgRo", "mtdGaugeGp"].forEach(id => {
        const c = byId(id);
        if (c) c.querySelector(".circle-gauge-value").textContent = "$0";
      });

      const advisorCards = byId("advisorCards");
      const leaderboardCards = byId("leaderboardCards");
      if (advisorCards) advisorCards.innerHTML = `<div class="loading">Awaiting CSV‚Ä¶</div>`;
      if (leaderboardCards) leaderboardCards.innerHTML = "";
      return;
    }

    const today = computeTodayMetrics();
    const mtd = computeMtdMetrics();
    const mixRaw = computeMtdMixAllAdvisors();

    if (todaySummaryEl) {
      const avgRoToday = today.roCount ? today.totalGross / today.roCount : 0;
      todaySummaryEl.textContent =
        `ROs: ${today.roCount} ¬∑ Gross: ${formatCurrency(today.totalGross)} ¬∑ Avg RO: ${formatCurrency(avgRoToday)}`;
    }

    if (mtdSummaryEl) {
      const avgRoMtd = mtd.roCount ? mtd.totalGross / mtd.roCount : 0;
      mtdSummaryEl.textContent =
        `MTD ROs: ${mtd.roCount} ¬∑ Gross: ${formatCurrency(mtd.totalGross)} ¬∑ Avg RO: ${formatCurrency(avgRoMtd)} ¬∑ GP ${mtd.gpPct.toFixed(1)}%`;
    }

    const todayAvgRo = today.roCount ? today.totalGross / today.roCount : 0;
    const todayHoursRat = today.clockedHrs ? (today.chargedHrs / today.clockedHrs) : 0;
    const mtdAvgRo = mtd.roCount ? mtd.totalGross / mtd.roCount : 0;

    renderGaugeCurrency(
      "todayGaugeLabour",
      "Today Labour Gross",
      "All advisors ¬∑ closed ROs",
      today.totalGross,
      toNumber(settings.dailyLabourTarget)
    );

    renderGaugeCurrency(
      "mtdGaugeLabour",
      "MTD Labour Gross",
      "All advisors ¬∑ MTD closed ROs",
      mtd.totalGross,
      toNumber(settings.mtdLabourTarget)
    );

    renderGaugeNumber(
      "todayGaugeAvgRo",
      "Today Avg RO",
      "Approx labour per RO",
      todayAvgRo || 0,
      toNumber(settings.dailyAvgRoTarget),
      "",
      false
    );

    renderGaugeNumber(
      "mtdGaugeAvgRo",
      "MTD Avg RO",
      "Approx labour per RO ¬∑ month",
      mtdAvgRo || 0,
      toNumber(settings.mtdAvgRoTarget),
      "",
      false
    );

    renderGaugeNumber(
      "todayGaugeHours",
      "Hours Sold / Clocked",
      "Technician hours for today",
      (todayHoursRat * 100) || 0,
      (toNumber(settings.dailyHoursRatioTarget) || 1) * 100,
      "%",
      true
    );

    renderGaugeNumber(
      "mtdGaugeGp",
      "MTD GP%",
      "Margin on labour gross",
      mtd.gpPct || 0,
      toNumber(settings.mtdGpPctTarget) || 80,
      "%",
      true
    );

    const mix = {
      retail: mixRaw.retail,
      warranty: mixRaw.warranty,
      internal: mixRaw.internal,
      total: mixRaw.total,
      retailPct: mixRaw.retailPct,
      warrantyPct: mixRaw.warrantyPct,
      internalPct: mixRaw.internalPct
    };
    renderMixBar(mix);

    const decoratedMtdStats = mtd.advisorStats.map(a => {
      const leakagePct = a.hoursRatio ? (1 - a.hoursRatio) * 100 : 0;
      return { ...a, leakagePct };
    });

    renderAdvisorCards(decoratedMtdStats, mtd.rankMap || {});
    renderLeaderboards(decoratedMtdStats);

    const statusTotal = byId("statusTotal");
    if (statusTotal) {
      statusTotal.classList.remove("bad");
      statusTotal.classList.add("good");
      statusTotal.innerHTML =
        '<span class="status-dot"></span><span>CSV loaded ¬∑ ' +
        decoratedMtdStats.length +
        ' advisor(s)</span>';
    }
  }

  // ---------- CSV INGESTION ----------
  function ingestCsvRows(rows) {
    const clean = (rows || []).filter(r =>
      r && (r["InvoiceID"] || r["Advisor Name"])
    );

    state.rows = clean;
    state.loaded = clean.length > 0;
    state.error = null;

    initDateFromData();
    initAdvisorFilter();

    renderDashboard();
  }

  function parseCsvText(text) {
    try {
      const result = Papa.parse(text, {
        header: true,
        dynamicTyping: false,
        skipEmptyLines: true
      });
      ingestCsvRows(result.data || []);
    } catch (e) {
      console.error("CSV parse error", e);
      state.loaded = false;
      state.error = "Failed to parse CSV";

      const statusTotal = byId("statusTotal");
      if (statusTotal) {
        statusTotal.classList.remove("good");
        statusTotal.classList.add("bad");
        statusTotal.innerHTML =
          '<span class="status-dot"></span><span>Failed to parse CSV</span>';
      }
    }
  }

  function handleFileUpload(file) {
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => parseCsvText(e.target.result);
    reader.onerror = () => {
      console.error("File read failed");
      const statusTotal = byId("statusTotal");
      if (statusTotal) {
        statusTotal.classList.remove("good");
        statusTotal.classList.add("bad");
        statusTotal.innerHTML =
          '<span class="status-dot"></span><span>Error reading file</span>';
      }
    };
    reader.readAsText(file);
  }

  async function loadOnlineCsv() {
    const urlInput = byId("onlineCsvUrl");
    const onlineStat = byId("onlineStatus");
    const statusTotal = byId("statusTotal");

    const url = urlInput ? urlInput.value.trim() : "";
    if (!url) {
      if (onlineStat) onlineStat.textContent = "Please enter a CSV URL.";
      return;
    }

    if (onlineStat) onlineStat.textContent = "Loading online CSV‚Ä¶";

    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);
      const text = await res.text();

      settings.onlineCsvUrl = url;
      saveSettings();

      parseCsvText(text);

      if (onlineStat) onlineStat.textContent = "Online CSV loaded OK.";
      if (statusTotal) {
        statusTotal.classList.remove("bad");
        statusTotal.classList.add("good");
        statusTotal.innerHTML =
          '<span class="status-dot"></span><span>CSV loaded from online ‚úî</span>';
      }
    } catch (e) {
      console.error("Online CSV load failed", e);
      if (onlineStat) onlineStat.textContent = "Failed to load online CSV.";
      if (statusTotal) {
        statusTotal.classList.remove("good");
        statusTotal.classList.add("bad");
        statusTotal.innerHTML =
          '<span class="status-dot"></span><span>Online load failed</span>';
      }
    }
  }

  // ---------- GLOBAL INSIGHTS ----------
  function openGlobalInsights() {
    const modal = byId("advisorModal");
    const body = byId("advisorModalBody");
    const dateLbl = byId("modalDateLabel");
    const closeBtn = byId("advisorModalClose");

    if (!modal || !body) return;

    const today = state.filters.date || new Date();
    const y = today.getFullYear();
    const m = String(today.getMonth() + 1).padStart(2, "0");
    const d = String(today.getDate()).padStart(2, "0");
    if (dateLbl) dateLbl.textContent = `${d}/${m}/${y}`;

    if (!state.loaded || !state.rows.length) {
      body.innerHTML = "<p>Load CSV to see insights.</p>";
    } else {
      const todayM = computeTodayMetrics();
      const mtd = computeMtdMetrics();
      const mix = computeMtdMixAllAdvisors();

      const todayAvg = todayM.roCount ? todayM.totalGross / todayM.roCount : 0;
      const mtdAvg = mtd.roCount ? mtd.totalGross / mtd.roCount : 0;

      const lines = [];

      if (toNumber(settings.dailyLabourTarget)) {
        if (todayM.totalGross >= toNumber(settings.dailyLabourTarget)) {
          lines.push(`‚Ä¢ Today is on or above target ‚Äì ${formatCurrency(todayM.totalGross)} vs daily target ${formatCurrency(settings.dailyLabourTarget)}.`);
        } else {
          lines.push(`‚Ä¢ Today is behind gross target ‚Äì ${formatCurrency(todayM.totalGross)} vs daily target ${formatCurrency(settings.dailyLabourTarget)}.`);
        }
      }

      if (toNumber(settings.mtdLabourTarget)) {
        if (mtd.totalGross >= toNumber(settings.mtdLabourTarget)) {
          lines.push(`‚Ä¢ MTD gross is on/above target ‚Äì ${formatCurrency(mtd.totalGross)} vs MTD target ${formatCurrency(settings.mtdLabourTarget)}.`);
        } else {
          lines.push(`‚Ä¢ MTD gross is behind ‚Äì ${formatCurrency(mtd.totalGross)} vs target ${formatCurrency(settings.mtdLabourTarget)}.`);
        }
      }

      if (mix.total) {
        if (mix.retailPct < 50) {
          lines.push(`‚Ä¢ Retail mix soft ‚Äì customer ROs ${mix.retailPct.toFixed(1)}% of total. Push customer-pay opportunities & declined work.`);
        }
        if (mix.warrantyPct > 25) {
          lines.push(`‚Ä¢ Warranty share high at ${mix.warrantyPct.toFixed(1)}%. Check coding and ensure warranty isn't crowding out retail.`);
        }
        if (mix.internalPct > 20) {
          lines.push(`‚Ä¢ Internal ROs ${mix.internalPct.toFixed(1)}%. Watch that reconditioning isn't consuming prime capacity.`);
        }
      }

      if (!lines.length) {
        lines.push("‚Ä¢ Performance steady. Maintain rhythm and follow-up discipline.");
      }

      body.innerHTML = `
        <h3>Service Department ‚Äì Insights</h3>
        <p><strong>Today:</strong> ${todayM.roCount} ROs ¬∑ ${formatCurrency(todayM.totalGross)} ¬∑ Avg RO ${formatCurrency(todayAvg)}</p>
        <p><strong>Month-to-date:</strong> ${mtd.roCount} ROs ¬∑ ${formatCurrency(mtd.totalGross)} ¬∑ Avg RO ${formatCurrency(mtdAvg)} ¬∑ GP% ${mtd.gpPct.toFixed(1)}%</p>
        <h3>Highlights</h3>
        <p>${lines.join("<br>")}</p>
      `;
    }

    modal.classList.remove("hidden");
    if (closeBtn) closeBtn.onclick = () => modal.classList.add("hidden");
    modal.addEventListener("click", e => {
      if (e.target === modal) modal.classList.add("hidden");
    });
  }

  // ---------- SETTINGS UI BINDING ----------
  function syncSettingsToInputs() {
    const map = {
      dailyLabourTarget: "dailyLabourTarget",
      dailyAvgRoTarget: "dailyAvgRoTarget",
      dailyHoursRatioTarget: "dailyHoursRatioTarget",
      mtdLabourTarget: "mtdLabourTarget",
      mtdAvgRoTarget: "mtdAvgRoTarget",
      mtdGpPctTarget: "mtdGpPctTarget",
      nonRetailMaxPct: "nonRetailMaxPct"
    };

    Object.keys(map).forEach(key => {
      const el = byId(map[key]);
      if (el) el.value = settings[key] ?? "";
    });

    const modeSel = byId("dataSourceMode");
    if (modeSel) modeSel.value = settings.dataSourceMode || "online";

    const urlArea = byId("settingsOnlineUrl");
    if (urlArea) urlArea.value = settings.onlineCsvUrl || "";
  }

  function readSettingsFromInputs() {
    settings.dailyLabourTarget = toNumber(byId("dailyLabourTarget")?.value);
    settings.dailyAvgRoTarget = toNumber(byId("dailyAvgRoTarget")?.value);
    settings.dailyHoursRatioTarget = parseFloat(byId("dailyHoursRatioTarget")?.value || 0) || 1.0;

    settings.mtdLabourTarget = toNumber(byId("mtdLabourTarget")?.value);
    settings.mtdAvgRoTarget = toNumber(byId("mtdAvgRoTarget")?.value);
    settings.mtdGpPctTarget = parseFloat(byId("mtdGpPctTarget")?.value || 0) || 80;

    settings.nonRetailMaxPct = parseFloat(byId("nonRetailMaxPct")?.value || 0) || 20;

    const modeSel = byId("dataSourceMode");
    if (modeSel) settings.dataSourceMode = modeSel.value || "online";

    const urlArea = byId("settingsOnlineUrl");
    if (urlArea && urlArea.value.trim()) {
      settings.onlineCsvUrl = urlArea.value.trim();
      const onlineInput = byId("onlineCsvUrl");
      if (onlineInput) onlineInput.value = settings.onlineCsvUrl;
    }
  }

  // ---------- INIT / EVENT WIRING ----------
  document.addEventListener("DOMContentLoaded", () => {
    loadSettings();
    syncSettingsToInputs();

    const onlineInput = byId("onlineCsvUrl");
    if (onlineInput && settings.onlineCsvUrl) {
      onlineInput.value = settings.onlineCsvUrl;
    }

    const fileInput = byId("fileInput");
    const btnUpload = byId("btnUpload");
    const btnOnlineLoad = byId("btnOnlineLoad");
    const reloadOnline = byId("reloadOnlineBtn");
    const advisorFilter = byId("advisorFilter");
    const datePicker = byId("datePicker");
    const insightsBtn = byId("insightsBtn");
    const leaderboardToggle = byId("leaderboardToggle");
    const closeLeaderboard = byId("closeLeaderboard");

    if (btnUpload && fileInput) {
      btnUpload.addEventListener("click", () => fileInput.click());
    }

    if (fileInput) {
      fileInput.addEventListener("change", () => {
        if (fileInput.files && fileInput.files[0]) {
          handleFileUpload(fileInput.files[0]);
        }
      });
    }

    if (btnOnlineLoad) {
      btnOnlineLoad.addEventListener("click", () => {
        loadOnlineCsv();
      });
    }

    if (reloadOnline) {
      reloadOnline.addEventListener("click", () => {
        loadOnlineCsv();
      });
    }

    if (advisorFilter) {
      advisorFilter.addEventListener("change", () => {
        state.filters.advisor = advisorFilter.value || "all";
        if (state.loaded) renderDashboard();
      });
    }

    if (datePicker) {
      datePicker.addEventListener("change", () => {
        if (datePicker.value) {
          const d = new Date(datePicker.value);
          state.filters.date = new Date(
            d.getFullYear(),
            d.getMonth(),
            d.getDate()
          );
        } else {
          state.filters.date = null;
        }
        if (state.loaded) renderDashboard();
      });
    }

    if (insightsBtn) {
      insightsBtn.addEventListener("click", openGlobalInsights);
    }

    const tabs = document.querySelectorAll(".top-tab");
    tabs.forEach(tab => {
      tab.addEventListener("click", () => {
        tabs.forEach(t => t.classList.remove("active"));
        tab.classList.add("active");

        const page = tab.getAttribute("data-page");
        const dash = byId("page-dashboard");
        const settingsPage = byId("page-settings");
        if (page === "dashboard") {
          dash && dash.classList.remove("hidden");
          settingsPage && settingsPage.classList.add("hidden");
        } else {
          dash && dash.classList.add("hidden");
          settingsPage && settingsPage.classList.remove("hidden");
        }
      });
    });

    const btnSaveSettings = byId("btnSaveSettings");
    const btnResetSettings = byId("btnResetSettings");

    if (btnSaveSettings) {
      btnSaveSettings.addEventListener("click", () => {
        readSettingsFromInputs();
        saveSettings();
        if (state.loaded) renderDashboard();
      });
    }

    if (btnResetSettings) {
      btnResetSettings.addEventListener("click", () => {
        settings = { ...defaultSettings };
        saveSettings();
        syncSettingsToInputs();
        if (state.loaded) renderDashboard();
      });
    }

    if (leaderboardToggle) {
      leaderboardToggle.addEventListener("click", () => {
        const panel = byId("leaderboardPanel");
        if (!panel) return;
        panel.classList.remove("hidden");
      });
    }

    if (closeLeaderboard) {
      closeLeaderboard.addEventListener("click", () => {
        const panel = byId("leaderboardPanel");
        if (!panel) return;
        panel.classList.add("hidden");
      });
    }

    const panel = byId("leaderboardPanel");
    if (panel) {
      panel.addEventListener("click", e => {
        if (e.target === panel) panel.classList.add("hidden");
      });
    }

    // Optional: auto-load on open if mode = online
    if (settings.dataSourceMode === "online" && settings.onlineCsvUrl) {
      loadOnlineCsv();
    }
  });
  </script>
</body>
</html>
